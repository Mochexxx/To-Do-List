<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>📝 To-Do List - Gestão de Tarefas e Notícias</title>        <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=1.2, user-scalable=yes" />
        <!-- React and ReactDOM CDN -->
        <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
        <!-- Babel for JSX support -->
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>        <style>
            * { 
                box-sizing: border-box; 
                margin: 0;
                padding: 0;
            }
            
            html {
                font-size: 14px; /* Reduzir tamanho base da fonte */
            }
            
            body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; 
                background-color: #f5f5f5;
                line-height: 1.4;
                font-size: 0.9rem;
            }
            
            #root { 
                min-height: 100vh;
                max-width: 100%;
                overflow-x: auto;
            }
            
            /* Responsive breakpoints */
            @media (max-width: 1200px) {
                html { font-size: 13px; }
            }
            
            @media (max-width: 768px) {
                html { font-size: 12px; }
            }
            
            /* Scroll customization */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
            }
            
            ::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .loading-spinner {
                animation: spin 1s linear infinite;
            }
        </style>
    </head>
    <body>        <div id="root"></div>
        
        <script src="../src/services/api.js"></script>
        <script src="../src/services/news.js"></script>
        <script type="text/babel">
// Countries data with flags and news codes
const countries = [
  { code: 'pt', name: 'Portugal', flag: '🇵🇹', newsCode: 'pt' },
  { code: 'br', name: 'Brasil', flag: '🇧🇷', newsCode: 'br' },
  { code: 'us', name: 'Estados Unidos', flag: '🇺🇸', newsCode: 'us' },
  { code: 'uk', name: 'Reino Unido', flag: '🇬🇧', newsCode: 'gb' },
  { code: 'es', name: 'Espanha', flag: '🇪🇸', newsCode: 'es' },
  { code: 'fr', name: 'França', flag: '🇫🇷', newsCode: 'fr' },
  { code: 'de', name: 'Alemanha', flag: '🇩🇪', newsCode: 'de' },
  { code: 'it', name: 'Itália', flag: '🇮🇹', newsCode: 'it' },
  { code: 'ca', name: 'Canadá', flag: '🇨🇦', newsCode: 'ca' },
  { code: 'au', name: 'Austrália', flag: '🇦🇺', newsCode: 'au' }
];

function LoginPage({ onSwitchToRegister }) {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');
    setLoading(true);

    try {
      await authService.login({ email, password });
      window.location.reload(); // Refresh to show authenticated state
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ maxWidth: '400px', margin: '0 auto', padding: '2rem' }}>
      <h2>🔐 Login</h2>
      <form onSubmit={handleSubmit}>
        <div style={{ marginBottom: '1rem' }}>
          <label>Email</label><br />
          <input
            type="email"
            value={email}
            onChange={e => setEmail(e.target.value)}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        <div style={{ marginBottom: '1rem' }}>
          <label>Senha</label><br />
          <input
            type="password"
            value={password}
            onChange={e => setPassword(e.target.value)}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        
        {error && (
          <div style={{ color: 'red', marginBottom: '1rem', padding: '0.5rem', backgroundColor: '#ffeeee', border: '1px solid red', borderRadius: '4px' }}>
            {error}
          </div>
        )}
        
        <button 
          type="submit" 
          disabled={loading}
          style={{ 
            width: '100%', 
            padding: '0.75rem', 
            backgroundColor: loading ? '#ccc' : '#007bff', 
            color: 'white', 
            border: 'none', 
            borderRadius: '4px',
            cursor: loading ? 'not-allowed' : 'pointer',
            marginBottom: '1rem'
          }}
        >
          {loading ? 'Entrando...' : 'Entrar'}
        </button>
      </form>
      
      <p style={{ textAlign: 'center' }}>
        Não tem uma conta? {' '}
        <button 
          onClick={onSwitchToRegister}
          style={{ background: 'none', border: 'none', color: '#007bff', cursor: 'pointer', textDecoration: 'underline' }}
        >
          Registre-se aqui
        </button>
      </p>
    </div>
  );
}

function RegisterPage({ onSwitchToLogin }) {
  const [formData, setFormData] = React.useState({
    username: '',
    email: '',
    password: '',
    confirmPassword: '',
    country: ''
  });
  const [error, setError] = React.useState('');
  const [loading, setLoading] = React.useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError('');

    if (formData.password !== formData.confirmPassword) {
      setError('As senhas não coincidem');
      return;
    }

    if (!formData.country) {
      setError('Por favor, selecione seu país');
      return;
    }

    setLoading(true);

    try {
      const selectedCountry = countries.find(c => c.code === formData.country);
      
      const userData = {
        username: formData.username,
        email: formData.email,
        password: formData.password,
        country: formData.country,
        countryName: selectedCountry.name,
        newsCountryCode: selectedCountry.newsCode,
        registeredAt: new Date().toISOString()
      };

      await authService.register(userData);
      alert('Registro realizado com sucesso! Agora você pode fazer login.');
      onSwitchToLogin();
    } catch (error) {
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  const handleChange = (e) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value
    }));
  };

  return (
    <div style={{ maxWidth: '400px', margin: '0 auto', padding: '2rem' }}>
      <h2>📝 Registro</h2>
      <form onSubmit={handleSubmit}>
        <div style={{ marginBottom: '1rem' }}>
          <label>Nome de usuário</label><br />
          <input
            type="text"
            name="username"
            value={formData.username}
            onChange={handleChange}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        
        <div style={{ marginBottom: '1rem' }}>
          <label>Email</label><br />
          <input
            type="email"
            name="email"
            value={formData.email}
            onChange={handleChange}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        
        <div style={{ marginBottom: '1rem' }}>
          <label>País *</label><br />
          <small style={{ color: '#666' }}>Seu país influenciará a priorização das notícias por região</small><br />
          <select
            name="country"
            value={formData.country}
            onChange={handleChange}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          >
            <option value="">Selecione seu país</option>
            {countries.map(country => (
              <option key={country.code} value={country.code}>
                {country.flag} {country.name}
              </option>
            ))}
          </select>
        </div>
        
        <div style={{ marginBottom: '1rem' }}>
          <label>Senha</label><br />
          <input
            type="password"
            name="password"
            value={formData.password}
            onChange={handleChange}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        
        <div style={{ marginBottom: '1rem' }}>
          <label>Confirmar senha</label><br />
          <input
            type="password"
            name="confirmPassword"
            value={formData.confirmPassword}
            onChange={handleChange}
            required
            style={{ width: '100%', padding: '0.5rem', marginTop: '0.5rem' }}
          />
        </div>
        
        {error && (
          <div style={{ color: 'red', marginBottom: '1rem', padding: '0.5rem', backgroundColor: '#ffeeee', border: '1px solid red', borderRadius: '4px' }}>
            {error}
          </div>
        )}
        
        <button 
          type="submit" 
          disabled={loading}
          style={{ 
            width: '100%', 
            padding: '0.75rem', 
            backgroundColor: loading ? '#ccc' : '#28a745', 
            color: 'white', 
            border: 'none', 
            borderRadius: '4px',
            cursor: loading ? 'not-allowed' : 'pointer',
            marginBottom: '1rem'
          }}
        >
          {loading ? 'Registrando...' : 'Registrar'}
        </button>
      </form>
      
      <p style={{ textAlign: 'center' }}>
        Já tem uma conta? {' '}
        <button 
          onClick={onSwitchToLogin}
          style={{ background: 'none', border: 'none', color: '#007bff', cursor: 'pointer', textDecoration: 'underline' }}
        >
          Faça login aqui
        </button>
      </p>
    </div>
  );
}

// Formulário Simples para Criação Rápida de Tarefas
function SimpleTaskForm({ onTaskCreated, onSwitchToComplete }) {
  const [formData, setFormData] = React.useState({
    title: '',
    description: '',
    priority: 'média',
    dueDate: ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const task = await tasksService.createTask({
        ...formData,
        category: 'pessoal',
        status: 'pendente',
        startDate: '',
        isRecurrent: false,
        tags: [],
        estimatedDuration: ''
      });
      onTaskCreated(task);
      setFormData({ title: '', description: '', priority: 'média', dueDate: '' });
    } catch (error) {
      alert('Erro ao criar tarefa: ' + error.message);
    }
  };

  const handleChange = (e) => {
    setFormData(prev => ({
      ...prev,
      [e.target.name]: e.target.value
    }));
  };

  return (
    <div style={{ 
      padding: '1.5rem', 
      border: '1px solid #e3f2fd', 
      borderRadius: '12px', 
      backgroundColor: '#f8fbff',
      marginBottom: '1rem'
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
        <h4 style={{ margin: 0, color: '#1976d2', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          ⚡ Criação Rápida
        </h4>
        <button
          type="button"
          onClick={onSwitchToComplete}
          style={{
            padding: '0.4rem 0.8rem',
            backgroundColor: '#2196f3',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '0.8rem',
            transition: 'background-color 0.2s'
          }}
        >
          🔧 Modo Completo
        </button>
      </div>

      <form onSubmit={handleSubmit}>
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📝 Título da Tarefa *</label><br />
          <input
            type="text"
            name="title"
            value={formData.title}
            onChange={handleChange}
            required
            placeholder="O que você precisa fazer?"
            style={{ 
              width: '100%', 
              padding: '0.75rem', 
              fontSize: '0.9rem',
              border: '1px solid #ddd',
              borderRadius: '6px',
              marginTop: '0.25rem'
            }}
          />
        </div>

        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>⏱️ Prioridade</label><br />
            <select
              name="priority"
              value={formData.priority}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            >
              <option value="baixa">🟢 Baixa</option>
              <option value="média">🟡 Média</option>
              <option value="alta">🟠 Alta</option>
              <option value="urgente">🔴 Urgente</option>
            </select>
          </div>
          
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📅 Prazo (opcional)</label><br />
            <input
              type="date"
              name="dueDate"
              value={formData.dueDate}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            />
          </div>
        </div>
        
        <div style={{ marginBottom: '1.5rem' }}>
          <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📄 Descrição (opcional)</label><br />
          <textarea
            name="description"
            value={formData.description}
            onChange={handleChange}
            placeholder="Adicione detalhes sobre a tarefa..."
            style={{ 
              width: '100%', 
              padding: '0.75rem', 
              minHeight: '80px', 
              fontSize: '0.9rem',
              border: '1px solid #ddd',
              borderRadius: '6px',
              marginTop: '0.25rem',
              resize: 'vertical'
            }}
          />
        </div>
        
        <button 
          type="submit" 
          style={{ 
            width: '100%', 
            padding: '0.75rem', 
            backgroundColor: '#4caf50', 
            color: 'white', 
            border: 'none', 
            borderRadius: '6px', 
            cursor: 'pointer', 
            fontSize: '1rem',
            fontWeight: '500',
            transition: 'background-color 0.2s'
          }}
        >
          ⚡ Criar Tarefa Rápida
        </button>
      </form>
    </div>
  );
}

// Formulário Completo para Criação Detalhada de Tarefas
function CompleteTaskForm({ onTaskCreated, onSwitchToSimple }) {
  const [formData, setFormData] = React.useState({
    title: '',
    description: '',
    priority: 'média',
    startDate: '',
    dueDate: '',
    category: 'pessoal',
    status: 'pendente',
    isRecurrent: false,
    tags: '',
    estimatedDuration: ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const task = await tasksService.createTask({
        ...formData,
        tags: formData.tags ? formData.tags.split(',').map(tag => tag.trim()) : []
      });
      onTaskCreated(task);
      setFormData({ 
        title: '', 
        description: '', 
        priority: 'média', 
        startDate: '',
        dueDate: '', 
        category: 'pessoal',
        status: 'pendente',
        isRecurrent: false,
        tags: '',
        estimatedDuration: ''
      });
    } catch (error) {
      alert('Erro ao criar tarefa: ' + error.message);
    }
  };

  const handleChange = (e) => {
    const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;
    setFormData(prev => ({
      ...prev,
      [e.target.name]: value
    }));
  };

  return (
    <div style={{ 
      padding: '1.5rem', 
      border: '1px solid #e8f5e8', 
      borderRadius: '12px', 
      backgroundColor: '#f9fff9',
      marginBottom: '1rem'
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
        <h4 style={{ margin: 0, color: '#2e7d32', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          🔧 Criação Completa
        </h4>
        <button
          type="button"
          onClick={onSwitchToSimple}
          style={{
            padding: '0.4rem 0.8rem',
            backgroundColor: '#4caf50',
            color: 'white',
            border: 'none',
            borderRadius: '6px',
            cursor: 'pointer',
            fontSize: '0.8rem',
            transition: 'background-color 0.2s'
          }}
        >
          ⚡ Modo Rápido
        </button>
      </div>

      <form onSubmit={handleSubmit}>
        {/* Título */}
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📝 Título *</label><br />
          <input
            type="text"
            name="title"
            value={formData.title}
            onChange={handleChange}
            required
            placeholder="Digite o título da tarefa"
            style={{ 
              width: '100%', 
              padding: '0.75rem', 
              fontSize: '0.9rem',
              border: '1px solid #ddd',
              borderRadius: '6px',
              marginTop: '0.25rem'
            }}
          />
        </div>

        {/* Categoria e Prioridade */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📱 Categoria</label><br />
            <select
              name="category"
              value={formData.category}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            >
              <option value="pessoal">📱 Pessoal</option>
              <option value="trabalho">💼 Trabalho</option>
              <option value="estudos">📚 Estudos</option>
              <option value="saude">🏥 Saúde</option>
              <option value="financas">💰 Finanças</option>
            </select>
          </div>
          
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>⏱️ Prioridade</label><br />
            <select
              name="priority"
              value={formData.priority}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            >
              <option value="baixa">🟢 Baixa</option>
              <option value="média">🟡 Média</option>
              <option value="alta">🟠 Alta</option>
              <option value="urgente">🔴 Urgente</option>
            </select>
          </div>
        </div>

        {/* Datas */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📅 Data de Início</label><br />
            <input
              type="date"
              name="startDate"
              value={formData.startDate}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            />
          </div>
          
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📅 Data de Prazo</label><br />
            <input
              type="datetime-local"
              name="dueDate"
              value={formData.dueDate}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            />
          </div>
        </div>

        {/* Estado e Duração */}
        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>✅ Estado</label><br />
            <select
              name="status"
              value={formData.status}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            >
              <option value="pendente">⏳ Pendente</option>
              <option value="em progresso">🔄 Em Progresso</option>
              <option value="concluída">✅ Concluída</option>
            </select>
          </div>
          
          <div>
            <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>🕒 Duração Estimada</label><br />
            <select
              name="estimatedDuration"
              value={formData.estimatedDuration}
              onChange={handleChange}
              style={{ 
                width: '100%', 
                padding: '0.75rem', 
                fontSize: '0.9rem',
                border: '1px solid #ddd',
                borderRadius: '6px',
                marginTop: '0.25rem'
              }}
            >
              <option value="">Selecionar...</option>
              <option value="15min">⚡ 15 minutos</option>
              <option value="30min">🕑 30 minutos</option>
              <option value="1h">🕐 1 hora</option>
              <option value="2h">🕑 2 horas</option>
              <option value="4h">🕓 4 horas</option>
              <option value="8h">🕗 8 horas (1 dia)</option>
              <option value="1d+">📅 Mais de 1 dia</option>
            </select>
          </div>
        </div>
        
        {/* Descrição */}
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📄 Descrição</label><br />
          <textarea
            name="description"
            value={formData.description}
            onChange={handleChange}
            placeholder="Descreva os detalhes da tarefa..."
            style={{ 
              width: '100%', 
              padding: '0.75rem', 
              minHeight: '100px', 
              fontSize: '0.9rem',
              border: '1px solid #ddd',
              borderRadius: '6px',
              marginTop: '0.25rem',
              resize: 'vertical'
            }}
          />
        </div>

        {/* Etiquetas */}
        <div style={{ marginBottom: '1rem' }}>
          <label style={{ fontSize: '0.9rem', fontWeight: '500' }}>📌 Etiquetas (separadas por vírgula)</label><br />
          <input
            type="text"
            name="tags"
            value={formData.tags}
            onChange={handleChange}
            placeholder="ex: urgente, trabalho, reunião"
            style={{ 
              width: '100%', 
              padding: '0.75rem', 
              fontSize: '0.9rem',
              border: '1px solid #ddd',
              borderRadius: '6px',
              marginTop: '0.25rem'
            }}
          />
        </div>

        {/* Recorrente */}
        <div style={{ marginBottom: '1.5rem' }}>
          <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', fontSize: '0.9rem', fontWeight: '500' }}>
            <input 
              type="checkbox" 
              name="isRecurrent"
              checked={formData.isRecurrent} 
              onChange={handleChange}
              style={{ marginRight: '0.5rem', transform: 'scale(1.2)' }}
            />
            <span>🔁 Tarefa Recorrente</span>
          </label>
          <small style={{ color: '#666', fontSize: '0.8rem', marginLeft: '1.7rem' }}>
            Marque se esta tarefa se repete regularmente
          </small>
        </div>
        
        <button 
          type="submit" 
          style={{ 
            width: '100%', 
            padding: '0.75rem', 
            backgroundColor: '#2e7d32', 
            color: 'white', 
            border: 'none', 
            borderRadius: '6px', 
            cursor: 'pointer', 
            fontSize: '1rem',
            fontWeight: '500',
            transition: 'background-color 0.2s'
          }}
        >
          🔧 Criar Tarefa Completa
        </button>
      </form>
    </div>
  );
}

function TaskForm({ onTaskCreated }) {
  const [isSimpleMode, setIsSimpleMode] = React.useState(true);

  if (isSimpleMode) {
    return (
      <SimpleTaskForm 
        onTaskCreated={onTaskCreated} 
        onSwitchToComplete={() => setIsSimpleMode(false)} 
      />
    );
  }

  return (
    <CompleteTaskForm 
      onTaskCreated={onTaskCreated} 
      onSwitchToSimple={() => setIsSimpleMode(true)} 
    />
  );
}

function TaskItem({ task, onTaskUpdated, onTaskDeleted, compact = false }) {
  const [isEditing, setIsEditing] = React.useState(false);
  const [editData, setEditData] = React.useState(task);

  const priorityColors = {
    baixa: '#28a745',
    média: '#ffc107',
    alta: '#fd7e14',
    urgente: '#dc3545'
  };

  const statusIcons = {
    pendente: '⏳',
    em_progresso: '🔄',
    concluída: '✅'
  };

  const handleStatusChange = async (newStatus) => {
    try {
      const updatedTask = await tasksService.updateTask(task._id, { status: newStatus });
      onTaskUpdated(updatedTask);
    } catch (error) {
      alert('Erro ao atualizar tarefa: ' + error.message);
    }
  };

  const handleSaveEdit = async () => {
    try {
      const updatedTask = await tasksService.updateTask(task._id, editData);
      onTaskUpdated(updatedTask);
      setIsEditing(false);
    } catch (error) {
      alert('Erro ao salvar edição: ' + error.message);
    }
  };

  const handleDelete = async () => {
    if (confirm('Tem certeza que deseja deletar esta tarefa?')) {
      try {
        await tasksService.deleteTask(task._id);
        onTaskDeleted(task._id);
      } catch (error) {
        alert('Erro ao deletar tarefa: ' + error.message);
      }
    }
  };

  const isOverdue = task.dueDate && new Date(task.dueDate) < new Date() && task.status !== 'concluída';

  if (isEditing) {
    return (
      <div style={{ 
        padding: compact ? '0.5rem' : '1rem', 
        border: '1px solid #ddd', 
        borderRadius: '8px', 
        marginBottom: compact ? '0.5rem' : '1rem',
        backgroundColor: '#f8f9fa',
        fontSize: compact ? '0.9rem' : '1rem'
      }}>
        <div style={{ marginBottom: '0.5rem' }}>
          <input
            type="text"
            value={editData.title}
            onChange={e => setEditData(prev => ({ ...prev, title: e.target.value }))}
            style={{ width: '100%', padding: '0.25rem', fontSize: compact ? '0.8rem' : '0.9rem' }}
          />
        </div>
        <div style={{ marginBottom: '0.5rem' }}>
          <textarea
            value={editData.description}
            onChange={e => setEditData(prev => ({ ...prev, description: e.target.value }))}
            style={{ width: '100%', padding: '0.25rem', minHeight: compact ? '40px' : '60px', fontSize: compact ? '0.8rem' : '0.9rem' }}
          />
        </div>
        <div style={{ display: 'flex', gap: '0.25rem' }}>
          <button onClick={handleSaveEdit} style={{ padding: '0.25rem 0.5rem', backgroundColor: '#28a745', color: 'white', border: 'none', borderRadius: '4px', fontSize: compact ? '0.7rem' : '0.8rem' }}>
            ✓
          </button>
          <button onClick={() => setIsEditing(false)} style={{ padding: '0.25rem 0.5rem', backgroundColor: '#6c757d', color: 'white', border: 'none', borderRadius: '4px', fontSize: compact ? '0.7rem' : '0.8rem' }}>
            ✕
          </button>
        </div>
      </div>
    );
  }

  return (
    <div style={{ 
      padding: compact ? '0.5rem' : '1rem', 
      border: `1px solid ${isOverdue ? '#dc3545' : '#ddd'}`, 
      borderRadius: '8px', 
      marginBottom: compact ? '0.5rem' : '1rem',
      backgroundColor: isOverdue ? '#fff5f5' : 'white',
      opacity: task.status === 'concluída' ? 0.7 : 1,
      fontSize: compact ? '0.8rem' : '1rem'
    }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.25rem' }}>
        <h4 style={{ 
          margin: 0, 
          textDecoration: task.status === 'concluída' ? 'line-through' : 'none',
          color: isOverdue ? '#dc3545' : 'inherit',
          fontSize: compact ? '0.9rem' : '1.1rem',
          lineHeight: '1.2'
        }}>
          {statusIcons[task.status]} {task.title}
        </h4>
        <span style={{ 
          backgroundColor: priorityColors[task.priority], 
          color: 'white', 
          padding: compact ? '0.125rem 0.25rem' : '0.25rem 0.5rem', 
          borderRadius: '12px', 
          fontSize: compact ? '0.6rem' : '0.8rem',
          fontWeight: 'bold',
          flexShrink: 0
        }}>
          {task.priority}
        </span>
      </div>
      
      {task.description && !compact && (
        <p style={{ margin: '0.25rem 0', color: '#666', fontSize: compact ? '0.7rem' : '0.9rem' }}>{task.description}</p>
      )}
      
      <div style={{ display: 'flex', gap: compact ? '0.5rem' : '1rem', marginBottom: compact ? '0.5rem' : '1rem', fontSize: compact ? '0.7rem' : '0.9rem', color: '#666', flexWrap: 'wrap' }}>
        <span>📂 {task.category}</span>
        {task.dueDate && (
          <span style={{ color: isOverdue ? '#dc3545' : 'inherit' }}>
            ⏰ {new Date(task.dueDate).toLocaleDateString('pt-BR')}
            {isOverdue && ' (!)'}
          </span>
        )}
      </div>
      
      <div style={{ display: 'flex', gap: '0.25rem', flexWrap: 'wrap' }}>
        <select
          value={task.status}
          onChange={e => handleStatusChange(e.target.value)}
          style={{ padding: compact ? '0.125rem' : '0.25rem', fontSize: compact ? '0.7rem' : '0.9rem', flex: compact ? 'none' : '1' }}
        >
          <option value="pendente">⏳ Pendente</option>
          <option value="em_progresso">🔄 Em Progresso</option>
          <option value="concluída">✅ Concluída</option>
        </select>
        
        <button 
          onClick={() => setIsEditing(true)}
          style={{ padding: compact ? '0.125rem 0.25rem' : '0.25rem 0.5rem', backgroundColor: '#007bff', color: 'white', border: 'none', borderRadius: '4px', fontSize: compact ? '0.7rem' : '0.9rem' }}
        >
          {compact ? '✏️' : '✏️ Editar'}
        </button>
        
        <button 
          onClick={handleDelete}
          style={{ padding: compact ? '0.125rem 0.25rem' : '0.25rem 0.5rem', backgroundColor: '#dc3545', color: 'white', border: 'none', borderRadius: '4px', fontSize: compact ? '0.7rem' : '0.9rem' }}
        >
          {compact ? '🗑️' : '🗑️ Deletar'}
        </button>
      </div>
    </div>
  );
}

function NewsSection({ darkMode = false }) {
  const [news, setNews] = React.useState([]);
  const [loading, setLoading] = React.useState(true);
  const [selectedCategory, setSelectedCategory] = React.useState('general');
  const [page, setPage] = React.useState(1);
  const [hasMore, setHasMore] = React.useState(true);
  const [apiStatus, setApiStatus] = React.useState('unknown'); // 'working', 'error', 'unknown'
  const newsContainerRef = React.useRef(null);

  const categories = [
    { id: 'general', name: 'Geral', icon: '📰' },
    { id: 'business', name: 'Negócios', icon: '💼' },
    { id: 'technology', name: 'Tecnologia', icon: '💻' },
    { id: 'sports', name: 'Esportes', icon: '⚽' },
    { id: 'health', name: 'Saúde', icon: '🏥' },
    { id: 'entertainment', name: 'Entretenimento', icon: '🎬' }
  ];
  React.useEffect(() => {
    setNews([]);
    setPage(1);
    setHasMore(true);
    setLoading(true);
    setApiStatus('unknown');
    // Carrega a primeira página
    loadNews(1, true);
    // eslint-disable-next-line
  }, [selectedCategory]);

  React.useEffect(() => {
    const ref = newsContainerRef.current;
    if (!ref) return;
    let ticking = false;
    const handleScroll = () => {
      if (loading || !hasMore) return;
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const { scrollTop, scrollHeight, clientHeight } = ref;
          if (scrollTop + clientHeight >= scrollHeight - 100) {
            loadNews(page + 1);
          }
          ticking = false;
        });
        ticking = true;
      }
    };
    ref.addEventListener('scroll', handleScroll);
    return () => ref.removeEventListener('scroll', handleScroll);
  }, [loading, hasMore, page, newsContainerRef.current]);  const loadNews = async (pageToLoad = 1, reset = false) => {
    if (loading && !reset) return;
    setLoading(true);
    console.log('🔄 Carregando notícias - Categoria:', selectedCategory, 'Página:', pageToLoad);
    
    try {
      let articles = [];
      let apiWorked = false;
      
      // Primeiro, tentar carregar da API real
      if (window.newsService && selectedCategory) {
        try {
          console.log('🌐 Tentando carregar da NewsAPI...');
          setApiStatus('checking');
          
          if (selectedCategory === 'general') {
            // Para 'geral', carregar as principais notícias
            articles = await newsService.getTopHeadlines('us', 50);
          } else {
            // Para categorias específicas
            articles = await newsService.getNewsByCategory(selectedCategory, 'us', 50, pageToLoad);
          }
          
          console.log('📰 Artigos recebidos da API:', articles?.length || 0);
          
          if (articles && articles.length > 0) {
            apiWorked = true;
            setApiStatus('working');
            console.log('✅ API funcionou! Usando dados reais');
            
            // Se for reset, substituir tudo
            if (reset || pageToLoad === 1) {
              setNews(articles);
            } else {
              // Se for scroll infinito, adicionar aos existentes
              setNews(prev => [...prev, ...articles]);
            }
            
            // Verificar se há mais páginas
            setHasMore(articles.length === 50);
            setPage(pageToLoad);
          }
        } catch (apiError) {
          console.warn('⚠️ Erro na API, tentando fallback:', apiError.message);
          setApiStatus('error');
          apiWorked = false;
        }
      }
      
      // Se a API não funcionou, usar dados mock
      if (!apiWorked) {
        console.log('📝 Usando dados mock como fallback');
        setApiStatus('mock');
        const mockData = getMockNews();
        console.log('📊 Total de notícias mock disponíveis:', mockData.length);
        
        // Simular paginação nos dados mock
        const itemsPerPage = 20;
        const startIndex = (pageToLoad - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageData = mockData.slice(startIndex, endIndex);
        
        console.log('📄 Dados da página', pageToLoad, ':', pageData.length, 'itens');
        
        if (reset || pageToLoad === 1) {
          setNews(pageData);
        } else {
          setNews(prev => [...prev, ...pageData]);
        }
        
        // Verificar se há mais páginas nos dados mock
        setHasMore(endIndex < mockData.length);
        setPage(pageToLoad);
      }
      
    } catch (error) {
      console.error('❌ Erro geral ao carregar notícias:', error);
      setApiStatus('error');
      
      // Em caso de erro total, mostrar dados mock básicos
      const basicMockData = getMockNews().slice(0, 10);
      setNews(basicMockData);
      setHasMore(false);
    } finally {
      setLoading(false);
    }
  };const getMockNews = () => {
    const newsTemplates = {
      technology: [
        {
          title: "Inteligência Artificial: Nova Era da Automação",
          description: "As mais recentes inovações em IA estão revolucionando indústrias inteiras, desde a medicina até a fabricação de automóveis.",
          source: { name: "Tech Innovation Today" },
          category: "technology",
          urlToImage: "https://via.placeholder.com/300x150/007bff/ffffff?text=AI+Revolution"
        },
        {
          title: "Realidade Virtual: O Futuro dos Jogos e Trabalho",
          description: "A tecnologia VR está criando novas possibilidades para entretenimento, educação e colaboração remota.",
          source: { name: "VR Weekly" },
          category: "technology",
          urlToImage: "https://via.placeholder.com/300x150/6f42c1/ffffff?text=VR+Future"
        },
        {
          title: "Computação Quântica: Avanços Surpreendentes",
          description: "Empresas líderes em tecnologia anunciam descobertas que podem acelerar a era da computação quântica.",
          source: { name: "Quantum Computing News" },
          category: "technology",
          urlToImage: "https://via.placeholder.com/300x150/20c997/ffffff?text=Quantum+Tech"
        },
        {
          title: "Cibersegurança: Novas Ameaças e Soluções",
          description: "Especialistas alertam para novas vulnerabilidades digitais e apresentam estratégias de proteção avançadas.",
          source: { name: "CyberSec Today" },
          category: "technology",
          urlToImage: "https://via.placeholder.com/300x150/dc3545/ffffff?text=CyberSecurity"
        }
      ],
      business: [
        {
          title: "Mercados Globais: Análise Semanal Completa",
          description: "Principais movimentações financeiras mundiais e suas implicações para investidores e economias locais.",
          source: { name: "Global Markets Weekly" },
          category: "business",
          urlToImage: "https://via.placeholder.com/300x150/28a745/ffffff?text=Global+Markets"
        },
        {
          title: "Startups: Unicórnios Emergentes de 2025",
          description: "Conheça as empresas emergentes que estão redefinindo setores tradicionais com inovação disruptiva.",
          source: { name: "Startup Spotlight" },
          category: "business",
          urlToImage: "https://via.placeholder.com/300x150/ffc107/000000?text=Startups+2025"
        },
        {
          title: "Sustentabilidade Empresarial em Foco",
          description: "Como grandes corporações estão implementando práticas sustentáveis para atender demandas ambientais.",
          source: { name: "Green Business Today" },
          category: "business",
          urlToImage: "https://via.placeholder.com/300x150/198754/ffffff?text=Green+Business"
        }
      ],
      health: [
        {
          title: "Medicina Personalizada: Revolução na Saúde",
          description: "Avanços em genética e biotecnologia permitem tratamentos sob medida para cada paciente.",
          source: { name: "Medical Breakthrough" },
          category: "health",
          urlToImage: "https://via.placeholder.com/300x150/0dcaf0/000000?text=Medicine+2025"
        },
        {
          title: "Telemedicina: Cuidados de Saúde Remotos",
          description: "A tecnologia digital está transformando o acesso aos cuidados de saúde em áreas remotas.",
          source: { name: "Digital Health News" },
          category: "health",
          urlToImage: "https://via.placeholder.com/300x150/6610f2/ffffff?text=Telemedicine"
        }
      ],
      sports: [
        {
          title: "Olimpíadas: Preparativos e Expectativas",
          description: "Atletas de todo o mundo se preparam para os próximos jogos olímpicos com treinos intensivos.",
          source: { name: "Olympic Sports Today" },
          category: "sports",
          urlToImage: "https://via.placeholder.com/300x150/fd7e14/ffffff?text=Olympics+2025"
        },
        {
          title: "Futebol Mundial: Transferências Surpreendentes",
          description: "O mercado de transferências agita o mundo do futebol com negociações milionárias inesperadas.",
          source: { name: "Football Transfer News" },
          category: "sports",
          urlToImage: "https://via.placeholder.com/300x150/198754/ffffff?text=Football+News"
        }
      ],
      entertainment: [
        {
          title: "Cinema: Estreias Aguardadas do Ano",
          description: "As produções cinematográficas mais esperadas chegam aos cinemas com tecnologia de ponta.",
          source: { name: "Hollywood Reporter" },
          category: "entertainment",
          urlToImage: "https://via.placeholder.com/300x150/e83e8c/ffffff?text=Cinema+2025"
        },
        {
          title: "Streaming: Guerra das Plataformas Continua",
          description: "Serviços de streaming investem bilhões em conteúdo original para conquistar novos assinantes.",
          source: { name: "Streaming Wars" },
          category: "entertainment",
          urlToImage: "https://via.placeholder.com/300x150/6f42c1/ffffff?text=Streaming+Wars"
        }
      ]
    };

    // Gerar artigos variados
    const mockArticles = [];
    const now = Date.now();
    
    // Criar 150 artigos (30 por categoria)
    Object.entries(newsTemplates).forEach(([category, templates]) => {
      for (let i = 0; i < 30; i++) {
        templates.forEach((template, templateIndex) => {
          const variation = Math.floor(i / templates.length) + 1;
          const article = {
            ...template,
            title: `${template.title} - Edição ${variation}`,
            publishedAt: new Date(now - (i * 2 + templateIndex) * 3600000).toISOString(),
            url: `#article-${category}-${i}-${templateIndex}`,
            id: `${category}-${i}-${templateIndex}`
          };
          
          // Adicionar alguma variação na descrição
          if (variation > 1) {
            article.description = `${template.description} Nova análise revela insights adicionais sobre este tópico em desenvolvimento.`;
          }
          
          mockArticles.push(article);
        });
      }
    });

    // Misturar os artigos para variedade
    mockArticles.sort(() => Math.random() - 0.5);
    
    console.log('📊 getMockNews - Categoria selecionada:', selectedCategory);
    console.log('📈 Total de artigos gerados:', mockArticles.length);

    // Filtrar por categoria se não for 'general'
    if (selectedCategory !== 'general') {
      const filtered = mockArticles.filter(article => article.category === selectedCategory);
      console.log('🏷️ Artigos filtrados para categoria', selectedCategory, ':', filtered.length);
      return filtered;
    }
    
    console.log('📰 Retornando todos os artigos (categoria geral):', mockArticles.length);
    return mockArticles;
  };  return (
    <div>
      <div style={{ marginBottom: '1rem', display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>
        {categories.map(category => (
          <button
            key={category.id}
            onClick={() => setSelectedCategory(category.id)}
            style={{
              padding: '0.4rem 0.8rem',
              border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
              borderRadius: '15px',
              backgroundColor: selectedCategory === category.id ? '#007bff' : (darkMode ? '#3a3a3a' : 'white'),
              color: selectedCategory === category.id ? 'white' : (darkMode ? '#fff' : '#333'),
              cursor: 'pointer',
              fontSize: '0.8rem'
            }}
          >
            {category.icon} {category.name}
          </button>
        ))}
      </div>
      
      {loading ? (
        <div style={{ textAlign: 'center', padding: '2rem' }}>
          <p>Carregando notícias...</p>
        </div>
      ) : (        <div style={{ maxHeight: '157vh', overflowY: 'auto', paddingRight: '0.5rem' }} ref={newsContainerRef}>
          {news.length > 0 ? (            news.map((article, index) => (
              <div key={article.id || index} style={{ 
                border: `1px solid ${darkMode ? '#555' : '#ddd'}`, 
                borderRadius: '6px', 
                padding: '0.8rem',
                marginBottom: '0.6rem',
                display: 'flex',
                flexDirection: 'column',
                gap: '0.4rem',
                backgroundColor: darkMode ? '#3a3a3a' : 'white',
                transition: 'transform 0.2s ease, box-shadow 0.2s ease'
              }}
              onMouseEnter={e => {
                e.currentTarget.style.transform = 'translateY(-1px)';
                e.currentTarget.style.boxShadow = darkMode ? '0 2px 8px rgba(255,255,255,0.1)' : '0 2px 8px rgba(0,0,0,0.1)';
              }}
              onMouseLeave={e => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = 'none';
              }}
              >                {article.urlToImage && (
                  <div style={{
                    width: '100%',
                    height: '140px',
                    borderRadius: '6px',
                    overflow: 'hidden',
                    position: 'relative',
                    cursor: 'pointer',
                    backgroundColor: darkMode ? '#444' : '#f0f0f0'
                  }}
                  onClick={() => article.url !== '#' && window.open(article.url, '_blank')}
                  >                    <img 
                      src={article.urlToImage} 
                      alt={article.title}
                      style={{ 
                        width: '100%', 
                        height: '100%', 
                        objectFit: 'cover',
                        objectPosition: 'center',
                        transition: 'transform 0.3s ease, filter 0.3s ease',
                        display: 'block'
                      }}
                      onError={(e) => {
                        e.target.parentElement.style.display = 'none';
                      }}
                      onMouseEnter={(e) => {
                        e.target.style.transform = 'scale(1.05)';
                        e.target.style.filter = 'brightness(1.1)';
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.transform = 'scale(1)';
                        e.target.style.filter = 'brightness(1)';
                      }}
                      loading="lazy"
                    />
                    {/* Overlay gradient para melhor legibilidade se houver texto sobreposto */}
                    <div style={{
                      position: 'absolute',
                      bottom: 0,
                      left: 0,
                      right: 0,
                      height: '30%',
                      background: 'linear-gradient(transparent, rgba(0,0,0,0.3))',
                      pointerEvents: 'none'
                    }}></div>
                  </div>
                )}
                <div>
                  <h4 style={{ 
                    margin: '0 0 0.3rem 0', 
                    fontSize: '0.9rem', 
                    lineHeight: '1.3',
                    color: darkMode ? '#fff' : '#333',
                    fontWeight: '600'
                  }}>
                    {article.title}
                  </h4>
                  
                  {article.description && (
                    <p style={{ 
                      margin: '0 0 0.5rem 0', 
                      color: darkMode ? '#ccc' : '#666', 
                      fontSize: '0.75rem', 
                      lineHeight: '1.4'
                    }}>
                      {article.description.length > 180 ? 
                        `${article.description.substring(0, 180)}...` : 
                        article.description
                      }
                    </p>
                  )}
                  
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    marginBottom: '0.5rem'
                  }}>
                    <div style={{
                      fontSize: '0.65rem', 
                      color: darkMode ? '#aaa' : '#999',
                      display: 'flex',
                      flexDirection: 'column',
                      gap: '0.1rem'
                    }}>
                      <span>
                        📰 {article.source?.name || 'Fonte não identificada'}
                      </span>
                      <span>
                        🕒 {new Date(article.publishedAt).toLocaleDateString('pt-BR', {
                          day: '2-digit',
                          month: '2-digit',
                          year: 'numeric',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </span>
                    </div>
                    
                    {/* Botão para ver notícia completa */}
                    {article.url !== '#' && (
                      <button
                        onClick={() => window.open(article.url, '_blank')}
                        style={{
                          padding: '0.3rem 0.6rem',
                          backgroundColor: '#007bff',
                          color: 'white',
                          border: 'none',
                          borderRadius: '4px',
                          cursor: 'pointer',
                          fontSize: '0.7rem',
                          fontWeight: '500',
                          transition: 'background-color 0.2s ease',
                          display: 'flex',
                          alignItems: 'center',
                          gap: '0.3rem'
                        }}
                        onMouseEnter={e => {
                          e.target.style.backgroundColor = '#0056b3';
                        }}
                        onMouseLeave={e => {
                          e.target.style.backgroundColor = '#007bff';
                        }}
                      >
                        📖 Ler
                      </button>
                    )}
                  </div>
                  
                  {/* Categoria tag */}
                  {article.category && (
                    <div style={{
                      display: 'inline-block',
                      padding: '0.2rem 0.4rem',
                      backgroundColor: darkMode ? '#555' : '#f8f9fa',
                      color: darkMode ? '#fff' : '#6c757d',
                      borderRadius: '10px',
                      fontSize: '0.6rem',
                      textTransform: 'capitalize',
                      fontWeight: '500'
                    }}>
                      {categories.find(cat => cat.id === article.category)?.icon || '📰'} {article.category}
                    </div>
                  )}
                </div>
              </div>
            ))) : (
            <div style={{ textAlign: 'center', padding: '2rem', color: darkMode ? '#ccc' : '#666' }}>
              <p>📭 Nenhuma notícia encontrada para esta categoria.</p>
              {apiStatus === 'error' && (
                <p style={{ fontSize: '0.8rem', marginTop: '1rem' }}>
                  ⚠️ Problemas de conectividade com a NewsAPI. Mostrando dados de demonstração.
                </p>
              )}
            </div>
          )}
          
          {loading && news.length > 0 && (
            <div style={{ 
              textAlign: 'center', 
              padding: '1rem',
              color: darkMode ? '#ccc' : '#666'
            }}>
              🔄 Carregando mais notícias...
            </div>
          )}
          
          {!hasMore && !loading && news.length > 0 && (
            <div style={{ 
              textAlign: 'center', 
              padding: '1rem', 
              color: '#aaa',
              fontSize: '0.9rem'
            }}>
              {apiStatus === 'working' ? (
                '✅ Você viu todas as notícias disponíveis!'
              ) : (
                `📊 ${news.length} notícias carregadas. ${apiStatus === 'mock' ? 'Dados de demonstração.' : ''}`
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}

function TasksDashboard({ tasks, onTaskUpdated, onTaskDeleted, navigateToView }) {
  const [filteredTasks, setFilteredTasks] = React.useState([]);
  const [filterStatus, setFilterStatus] = React.useState('todas');
  const [filterPriority, setFilterPriority] = React.useState('todas');
  const [stats, setStats] = React.useState({});

  React.useEffect(() => {
    applyFilters();
    setStats(tasksService.getStats());
  }, [tasks, filterStatus, filterPriority]);  const applyFilters = () => {
    let filtered = tasks;

    if (filterStatus !== 'todas') {
      if (filterStatus === 'atrasada') {
        // Filtro especial para tarefas atrasadas
        const today = new Date().toISOString().split('T')[0];
        filtered = filtered.filter(task => 
          task.dueDate && task.dueDate < today && task.status !== 'concluída'
        );
      } else {
        filtered = filtered.filter(task => task.status === filterStatus);
      }
    } else {
      // Por padrão, mostrar apenas tarefas não concluídas (atrasadas, pendentes, em progresso)
      filtered = filtered.filter(task => task.status !== 'concluída');
    }

    if (filterPriority !== 'todas') {
      filtered = filtered.filter(task => task.priority === filterPriority);
    }

    setFilteredTasks(filtered);
  };

  return (
    <div>      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
        <h3 style={{ margin: 0 }}>📋 Dashboard de Tarefas</h3>        <div style={{ display: 'flex', gap: '0.5rem' }}>
          <button 
            onClick={() => {
              setFilterStatus('atrasada');
              setFilterPriority('todas');
            }}
            style={{ 
              display: 'flex', alignItems: 'center', gap: '0.3rem',
              padding: '0.5rem 1rem', 
              backgroundColor: '#dc3545', 
              color: '#fff', 
              border: 'none', 
              borderRadius: '6px', 
              fontWeight: 600,
              fontSize: '0.85rem',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
            title="Ver Tarefas Atrasadas"
          >
            ⏰ Atrasadas ({stats.overdue || 0})
          </button>
          <button 
            onClick={() => {
              setFilterStatus('concluída');
              setFilterPriority('todas');
            }}
            style={{ 
              display: 'flex', alignItems: 'center', gap: '0.3rem',
              padding: '0.5rem 1rem', 
              backgroundColor: '#6c757d', 
              color: '#fff', 
              border: 'none', 
              borderRadius: '6px', 
              fontWeight: 600,
              fontSize: '0.85rem',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
            title="Ver Tarefas Completas"
          >
            ✅ Completas ({stats.completed || 0})
          </button>          <button 
            onClick={() => navigateToView('create')}
            style={{ 
              display: 'flex', alignItems: 'center', gap: '0.3rem',
              padding: '0.5rem 1rem', 
              backgroundColor: '#28a745', 
              color: '#fff', 
              border: 'none', 
              borderRadius: '6px', 
              fontWeight: 600,
              fontSize: '0.85rem',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
            title="Criar Nova Tarefa"
          >
            ➕ Nova Tarefa
          </button>
        </div>
      </div>

      {/* Filtros Principais */}
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', 
        gap: '1rem', 
        marginBottom: '1.5rem',
        padding: '1rem',
        backgroundColor: '#f8f9fa',
        borderRadius: '8px',
        border: '1px solid #e9ecef'
      }}>
        <div>
          <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem' }}>
            📊 Status:
          </label>
          <select
            value={filterStatus}
            onChange={e => setFilterStatus(e.target.value)}
            style={{ 
              width: '100%',
              padding: '0.5rem', 
              fontSize: '0.9rem', 
              border: '1px solid #ddd',
              borderRadius: '4px',
              backgroundColor: '#fff'
            }}
          >
            <option value="todas">🔄 Ativas (Não Concluídas)</option>
            <option value="pendente">📋 Pendentes</option>
            <option value="em_progresso">🔄 Em Progresso</option>
            <option value="concluída">✅ Concluídas</option>
            <option value="atrasada">⏰ Atrasadas</option>
          </select>
        </div>
        
        <div>
          <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 600, fontSize: '0.9rem' }}>
            🚨 Prioridade:
          </label>
          <select
            value={filterPriority}
            onChange={e => setFilterPriority(e.target.value)}
            style={{ 
              width: '100%',
              padding: '0.5rem', 
              fontSize: '0.9rem', 
              border: '1px solid #ddd',
              borderRadius: '4px',
              backgroundColor: '#fff'
            }}
          >
            <option value="todas">Todas as Prioridades</option>
            <option value="baixa">🟢 Baixa</option>
            <option value="média">🟡 Média</option>
            <option value="alta">🟠 Alta</option>
            <option value="urgente">🔴 Urgente</option>
          </select>
        </div>
        
        <div style={{ display: 'flex', alignItems: 'end' }}>
          <button
            onClick={() => {
              setFilterStatus('todas');
              setFilterPriority('todas');
            }}
            style={{
              width: '100%',
              padding: '0.5rem 1rem',
              backgroundColor: '#6c757d',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '0.9rem',
              fontWeight: 600,
              transition: 'all 0.2s'
            }}
          >
            🔄 Limpar Filtros
          </button>
        </div>
      </div>

      {/* Estatísticas Rápidas */}
      <div style={{ 
        display: 'grid', 
        gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', 
        gap: '0.5rem', 
        marginBottom: '1rem' 
      }}>
        <div style={{
          padding: '0.75rem',
          backgroundColor: '#e3f2fd',
          borderRadius: '6px',
          textAlign: 'center',
          border: '1px solid #bbdefb'
        }}>
          <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#1976d2' }}>
            {stats.total || 0}
          </div>
          <div style={{ fontSize: '0.8rem', color: '#666' }}>Total</div>
        </div>
        
        <div style={{
          padding: '0.75rem',
          backgroundColor: '#fff3e0',
          borderRadius: '6px',
          textAlign: 'center',
          border: '1px solid #ffcc02'
        }}>
          <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#f57c00' }}>
            {stats.pending || 0}
          </div>
          <div style={{ fontSize: '0.8rem', color: '#666' }}>Pendentes</div>
        </div>
        
        <div style={{
          padding: '0.75rem',
          backgroundColor: '#ffebee',
          borderRadius: '6px',
          textAlign: 'center',
          border: '1px solid #ffcdd2'
        }}>
          <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#d32f2f' }}>
            {stats.overdue || 0}
          </div>
          <div style={{ fontSize: '0.8rem', color: '#666' }}>Atrasadas</div>
        </div>
        
        <div style={{
          padding: '0.75rem',
          backgroundColor: '#e8f5e8',
          borderRadius: '6px',
          textAlign: 'center',
          border: '1px solid #c8e6c9'
        }}>
          <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#388e3c' }}>
            {stats.completed || 0}
          </div>
          <div style={{ fontSize: '0.8rem', color: '#666' }}>Concluídas</div>
        </div>        </div>

      {/* Informação sobre visualização padrão */}
      <div style={{ 
        backgroundColor: '#e7f3ff', 
        border: '1px solid #b3d9ff',
        borderRadius: '6px',
        padding: '0.75rem',
        marginBottom: '1rem',
        fontSize: '0.85rem',
        color: '#0066cc'
      }}>
        💡 <strong>Visualização:</strong> Por padrão, são mostradas apenas tarefas ativas (pendentes, em progresso e atrasadas). 
        Use o botão "✅ Completas" para ver tarefas concluídas.
      </div>

      {/* Compact Tasks List */}
      <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
        {filteredTasks.length > 0 ? (
          filteredTasks.map(task => (
            <TaskItem
              key={task._id}
              task={task}
              onTaskUpdated={onTaskUpdated}
              onTaskDeleted={onTaskDeleted}
              compact={true}
            />
          ))
        ) : (
          <div style={{ textAlign: 'center', padding: '1rem', color: '#666', fontSize: '0.9rem' }}>
            <p>Nenhuma tarefa encontrada.</p>
          </div>
        )}
      </div>
    </div>
  );
}

function CreateTaskPage({ onTaskCreated, onBack }) {
  return (
    <div style={{ maxWidth: '600px', margin: '0 auto', padding: '2rem' }}>
      <div style={{ marginBottom: '2rem' }}>
        <button 
          onClick={onBack}
          style={{ 
            padding: '0.5rem 1rem', 
            backgroundColor: '#6c757d', 
            color: 'white', 
            border: 'none', 
            borderRadius: '4px', 
            cursor: 'pointer',
            marginBottom: '1rem'
          }}
        >
          ← Voltar
        </button>
        <h2>➕ Criar Nova Tarefa</h2>
      </div>
      
      <TaskForm onTaskCreated={onTaskCreated} />
    </div>
  );
}

function ProfilePage({ onBack, user, stats }) {
  const [activeSection, setActiveSection] = React.useState('info');
  const [userInfo, setUserInfo] = React.useState({
    username: user.username || '',
    email: user.email || '',
    profileImage: user.profileImage || '',
    language: user.language || 'pt',
    timezone: user.timezone || 'Europe/Lisbon',
    notifications: user.notifications !== false,
    defaultPriority: user.defaultPriority || 'média'
  });
  const [passwordData, setPasswordData] = React.useState({
    currentPassword: '',
    newPassword: '',
    confirmPassword: ''
  });
  const [message, setMessage] = React.useState('');
  const [loading, setLoading] = React.useState(false);
  const [validationErrors, setValidationErrors] = React.useState({});

  // Validação em tempo real
  const validateField = (field, value) => {
    const errors = { ...validationErrors };
    
    switch (field) {
      case 'username':
        if (value && value.length < 3) {
          errors.username = 'Nome deve ter pelo menos 3 caracteres';
        } else {
          delete errors.username;
        }
        break;
      case 'email':
        if (value && !/^\S+@\S+\.\S+$/.test(value)) {
          errors.email = 'Email inválido';
        } else {
          delete errors.email;
        }
        break;
      case 'newPassword':
        if (value && value.length < 6) {
          errors.newPassword = 'Senha deve ter pelo menos 6 caracteres';
        } else {
          delete errors.newPassword;
        }
        break;
      case 'confirmPassword':
        if (value && value !== passwordData.newPassword) {
          errors.confirmPassword = 'Senhas não coincidem';
        } else {
          delete errors.confirmPassword;
        }
        break;
    }
    
    setValidationErrors(errors);
  };

  const handleUserInfoChange = (field, value) => {
    setUserInfo(prev => ({ ...prev, [field]: value }));
    validateField(field, value);
  };
  const handlePasswordDataChange = (field, value) => {
    setPasswordData(prev => ({ ...prev, [field]: value }));
    validateField(field, value);
  };
  const sections = [
    { id: 'info', name: '👤 Informações', icon: '👤' },
    { id: 'security', name: '🔐 Segurança', icon: '🔐' },
    { id: 'preferences', name: '⚙️ Preferências', icon: '⚙️' },
    { id: 'stats', name: '📊 Estatísticas', icon: '📊' },
    { id: 'actions', name: '🗑️ Ações', icon: '🗑️' }
  ];  const handleUserInfoUpdate = async () => {
    try {
      setLoading(true);
      setMessage('');
      const result = await authService.updateUserInfo(userInfo);
      
      // Atualizar estado local com dados atualizados
      const updatedUser = result.user || userInfo;
      setUserInfo(prev => ({
        ...prev,
        ...updatedUser
      }));
      
      // Atualizar dados globais se a função estiver disponível
      if (window.updateUserData) {
        window.updateUserData(updatedUser);
      }
      
      setMessage('Informações atualizadas com sucesso!');
      setTimeout(() => setMessage(''), 3000);
    } catch (error) {
      setMessage('Erro ao atualizar informações: ' + error.message);
    } finally {
      setLoading(false);
    }
  };
  const handlePasswordChange = async () => {
    if (passwordData.newPassword !== passwordData.confirmPassword) {
      setMessage('As senhas não coincidem');
      return;
    }
    if (passwordData.newPassword.length < 6) {
      setMessage('A senha deve ter pelo menos 6 caracteres');
      return;
    }
    try {
      setLoading(true);
      setMessage('');
      await authService.changePassword(passwordData.currentPassword, passwordData.newPassword);
      setMessage('Senha alterada com sucesso!');
      setPasswordData({ currentPassword: '', newPassword: '', confirmPassword: '' });
      setTimeout(() => setMessage(''), 3000);
    } catch (error) {
      setMessage('Erro ao alterar senha: ' + error.message);
    } finally {
      setLoading(false);
    }
  };
  const handleLogoutAll = async () => {
    if (confirm('Tem certeza que deseja terminar todas as sessões?')) {
      try {
        await authService.logoutAllSessions();
        setMessage('Todas as sessões foram terminadas. Você será redirecionado...');
        setTimeout(() => window.location.reload(), 2000);
      } catch (error) {
        setMessage('Erro ao terminar sessões: ' + error.message);
      }
    }
  };

  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) { // 5MB limit
      setMessage('Arquivo muito grande. Máximo 5MB permitido.');
      return;
    }

    if (!file.type.startsWith('image/')) {
      setMessage('Por favor, selecione apenas arquivos de imagem.');
      return;
    }

    try {
      // Convert file to base64 for storage
      const reader = new FileReader();
      reader.onload = async (e) => {
        const base64Image = e.target.result;
        const updatedUserInfo = { ...userInfo, profileImage: base64Image };
        setUserInfo(updatedUserInfo);
          // Save to database
        const result = await authService.updateUserInfo(updatedUserInfo);
        setMessage('Foto de perfil atualizada com sucesso!');
        setTimeout(() => setMessage(''), 3000);
      };
      reader.readAsDataURL(file);
    } catch (error) {
      setMessage('Erro ao fazer upload da imagem: ' + error.message);
    }
  };

  const handleExportData = async (format) => {
    try {
      const data = await tasksService.exportData(format);
      const blob = new Blob([data], { type: format === 'json' ? 'application/json' : 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks_export_${new Date().toISOString().split('T')[0]}.${format}`;
      a.click();
      URL.revokeObjectURL(url);
      setMessage(`Dados exportados em ${format.toUpperCase()}!`);
    } catch (error) {
      setMessage('Erro ao exportar dados: ' + error.message);
    }
  };
  const handleDeleteAccount = async () => {
    const confirmation = prompt('Para confirmar a eliminação da conta, digite "ELIMINAR":');
    if (confirmation === 'ELIMINAR') {
      try {
        // Delete account using the service
        await authService.deleteAccount();
        
        alert('Conta eliminada com sucesso!');
        window.location.reload();
      } catch (error) {
        setMessage('Erro ao eliminar conta: ' + error.message);
      }
    }
  };

  return (
    <div style={{ maxWidth: '1000px', margin: '0 auto', padding: '2rem' }}>      <div style={{ marginBottom: '2rem' }}>
        <button 
          onClick={onBack}
          style={{ 
            padding: '0.5rem 1rem', 
            backgroundColor: '#6c757d', 
            color: 'white', 
            border: 'none', 
            borderRadius: '4px', 
            cursor: 'pointer',
            marginBottom: '1rem'
          }}
        >
          ← Voltar
        </button>
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <h2>👤 Perfil do Utilizador</h2>
          <div style={{ 
            display: 'flex', 
            alignItems: 'center', 
            gap: '0.5rem',
            padding: '0.5rem 1rem',
            backgroundColor: authService.isOnlineMode ? '#e8f5e8' : '#fff3cd',
            color: authService.isOnlineMode ? '#155724' : '#856404',
            border: `1px solid ${authService.isOnlineMode ? '#c3e6cb' : '#ffeaa7'}`,
            borderRadius: '4px',
            fontSize: '0.8rem'
          }}>
            <span>{authService.isOnlineMode ? '🌐' : '💻'}</span>
            <span>{authService.isOnlineMode ? 'Online' : 'Offline'}</span>
          </div>
        </div>
      </div>

      {message && (
        <div style={{ 
          padding: '1rem', 
          marginBottom: '1rem', 
          backgroundColor: message.includes('Erro') ? '#ffebee' : '#e8f5e8',
          color: message.includes('Erro') ? '#d32f2f' : '#388e3c',
          border: `1px solid ${message.includes('Erro') ? '#d32f2f' : '#388e3c'}`,
          borderRadius: '4px'
        }}>
          {message}
        </div>
      )}

      <div style={{ display: 'grid', gridTemplateColumns: '250px 1fr', gap: '2rem' }}>
        {/* Sidebar Navigation */}
        <div style={{ backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px', height: 'fit-content' }}>
          {sections.map(section => (
            <button
              key={section.id}
              onClick={() => setActiveSection(section.id)}
              style={{
                width: '100%',
                padding: '0.75rem',
                marginBottom: '0.5rem',
                backgroundColor: activeSection === section.id ? '#007bff' : 'transparent',
                color: activeSection === section.id ? 'white' : '#333',
                border: 'none',
                borderRadius: '4px',
                cursor: 'pointer',
                textAlign: 'left',
                fontSize: '0.9rem'
              }}
            >
              {section.icon} {section.name}
            </button>
          ))}
        </div>

        {/* Content Area */}
        <div style={{ backgroundColor: 'white', padding: '2rem', borderRadius: '8px', border: '1px solid #ddd' }}>          {/* Informações do Utilizador */}
          {activeSection === 'info' && (
            <div>
              <h3>👤 Informações do Utilizador</h3>
              
              <div style={{ display: 'grid', gap: '1rem', marginBottom: '2rem' }}>                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Nome</label>
                  <input
                    type="text"
                    value={userInfo.username}
                    onChange={e => handleUserInfoChange('username', e.target.value)}
                    style={{ 
                      width: '100%', 
                      padding: '0.5rem', 
                      border: `1px solid ${validationErrors.username ? '#dc3545' : '#ddd'}`, 
                      borderRadius: '4px',
                      backgroundColor: validationErrors.username ? '#fff5f5' : 'white'
                    }}
                  />
                  {validationErrors.username && (
                    <div style={{ color: '#dc3545', fontSize: '0.8rem', marginTop: '0.25rem' }}>
                      {validationErrors.username}
                    </div>
                  )}
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Email</label>
                  <input
                    type="email"
                    value={userInfo.email}
                    onChange={e => handleUserInfoChange('email', e.target.value)}
                    style={{ 
                      width: '100%', 
                      padding: '0.5rem', 
                      border: `1px solid ${validationErrors.email ? '#dc3545' : '#ddd'}`, 
                      borderRadius: '4px',
                      backgroundColor: validationErrors.email ? '#fff5f5' : 'white'
                    }}
                  />
                  {validationErrors.email && (
                    <div style={{ color: '#dc3545', fontSize: '0.8rem', marginTop: '0.25rem' }}>
                      {validationErrors.email}
                    </div>
                  )}
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Foto de perfil</label>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                    {userInfo.profileImage && (
                      <img 
                        src={userInfo.profileImage} 
                        alt="Perfil atual" 
                        style={{ width: '80px', height: '80px', borderRadius: '50%', objectFit: 'cover', border: '2px solid #ddd' }}
                      />
                    )}
                    <div>
                      <input
                        type="file"
                        accept="image/*"
                        onChange={handleFileUpload}
                        style={{ marginBottom: '0.5rem' }}
                      />
                      <div style={{ fontSize: '0.8rem', color: '#666' }}>
                        Máximo 5MB. Formatos: JPG, PNG, GIF
                      </div>
                      {userInfo.profileImage && (
                        <button
                          type="button"
                          onClick={() => setUserInfo(prev => ({ ...prev, profileImage: '' }))}
                          style={{ 
                            marginTop: '0.5rem',
                            padding: '0.25rem 0.5rem', 
                            backgroundColor: '#dc3545', 
                            color: 'white', 
                            border: 'none', 
                            borderRadius: '4px', 
                            cursor: 'pointer',
                            fontSize: '0.8rem'
                          }}
                        >
                          🗑️ Remover foto
                        </button>
                      )}
                    </div>
                  </div>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Data de registo</label>
                  <input
                    type="text"
                    value={new Date(user.createdAt).toLocaleDateString('pt-PT')}
                    disabled
                    style={{ width: '100%', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px', backgroundColor: '#f5f5f5' }}
                  />
                </div>
              </div>
                <button 
                onClick={handleUserInfoUpdate}
                disabled={loading || Object.keys(validationErrors).some(key => ['username', 'email'].includes(key))}
                style={{ 
                  padding: '0.75rem 1.5rem', 
                  backgroundColor: loading || Object.keys(validationErrors).some(key => ['username', 'email'].includes(key)) ? '#6c757d' : '#28a745', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '4px', 
                  cursor: loading || Object.keys(validationErrors).some(key => ['username', 'email'].includes(key)) ? 'not-allowed' : 'pointer',
                  opacity: loading || Object.keys(validationErrors).some(key => ['username', 'email'].includes(key)) ? 0.6 : 1
                }}
              >
                {loading ? '⏳ Guardando...' : '💾 Guardar alterações'}
              </button>
            </div>
          )}          {/* Segurança */}
          {activeSection === 'security' && (
            <div>
              <h3>🔐 Segurança</h3>
              
              <div style={{ marginBottom: '2rem' }}>
                <h4>Alterar palavra-passe</h4>
                <div style={{ display: 'grid', gap: '1rem', marginBottom: '1rem' }}>                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Senha atual</label>
                    <input
                      type="password"
                      value={passwordData.currentPassword}
                      onChange={e => handlePasswordDataChange('currentPassword', e.target.value)}
                      style={{ width: '100%', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }}
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Nova senha</label>
                    <input
                      type="password"
                      value={passwordData.newPassword}
                      onChange={e => handlePasswordDataChange('newPassword', e.target.value)}
                      style={{ 
                        width: '100%', 
                        padding: '0.5rem', 
                        border: `1px solid ${validationErrors.newPassword ? '#dc3545' : '#ddd'}`, 
                        borderRadius: '4px',
                        backgroundColor: validationErrors.newPassword ? '#fff5f5' : 'white'
                      }}
                    />
                    {validationErrors.newPassword && (
                      <div style={{ color: '#dc3545', fontSize: '0.8rem', marginTop: '0.25rem' }}>
                        {validationErrors.newPassword}
                      </div>
                    )}
                  </div>
                  <div>
                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Confirmar nova senha</label>
                    <input
                      type="password"
                      value={passwordData.confirmPassword}
                      onChange={e => handlePasswordDataChange('confirmPassword', e.target.value)}
                      style={{ 
                        width: '100%', 
                        padding: '0.5rem', 
                        border: `1px solid ${validationErrors.confirmPassword ? '#dc3545' : '#ddd'}`, 
                        borderRadius: '4px',
                        backgroundColor: validationErrors.confirmPassword ? '#fff5f5' : 'white'
                      }}
                    />
                    {validationErrors.confirmPassword && (
                      <div style={{ color: '#dc3545', fontSize: '0.8rem', marginTop: '0.25rem' }}>
                        {validationErrors.confirmPassword}
                      </div>
                    )}
                  </div>
                </div>                <button 
                  onClick={handlePasswordChange}
                  disabled={loading || Object.keys(validationErrors).some(key => ['newPassword', 'confirmPassword'].includes(key)) || !passwordData.currentPassword || !passwordData.newPassword || !passwordData.confirmPassword}
                  style={{ 
                    padding: '0.5rem 1rem', 
                    backgroundColor: loading || Object.keys(validationErrors).some(key => ['newPassword', 'confirmPassword'].includes(key)) || !passwordData.currentPassword || !passwordData.newPassword || !passwordData.confirmPassword ? '#6c757d' : '#007bff', 
                    color: 'white', 
                    border: 'none', 
                    borderRadius: '4px', 
                    cursor: loading || Object.keys(validationErrors).some(key => ['newPassword', 'confirmPassword'].includes(key)) || !passwordData.currentPassword || !passwordData.newPassword || !passwordData.confirmPassword ? 'not-allowed' : 'pointer',
                    opacity: loading || Object.keys(validationErrors).some(key => ['newPassword', 'confirmPassword'].includes(key)) || !passwordData.currentPassword || !passwordData.newPassword || !passwordData.confirmPassword ? 0.6 : 1
                  }}
                >
                  {loading ? '⏳ Alterando...' : '🔐 Alterar senha'}
                </button>
              </div>
              
              <div>
                <h4>Sessões</h4>
                <p style={{ color: '#666', fontSize: '0.9rem' }}>Termine sua sessão atual em todos os dispositivos.</p>
                <button 
                  onClick={handleLogoutAll}
                  style={{ 
                    padding: '0.5rem 1rem', 
                    backgroundColor: '#ffc107', 
                    color: '#212529', 
                    border: 'none', 
                    borderRadius: '4px', 
                    cursor: 'pointer' 
                  }}
                >
                  🚪 Terminar todas as sessões
                </button>
              </div>
            </div>
          )}

          {/* Preferências */}
          {activeSection === 'preferences' && (
            <div>
              <h3>⚙️ Preferências</h3>
              
              <div style={{ display: 'grid', gap: '1.5rem' }}>
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Idioma</label>
                  <select
                    value={userInfo.language}
                    onChange={e => setUserInfo(prev => ({ ...prev, language: e.target.value }))}
                    style={{ width: '100%', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }}
                  >
                    <option value="pt">🇵🇹 Português</option>
                    <option value="en">🇺🇸 English</option>
                    <option value="es">🇪🇸 Español</option>
                    <option value="fr">🇫🇷 Français</option>
                  </select>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Fuso horário</label>
                  <select
                    value={userInfo.timezone}
                    onChange={e => setUserInfo(prev => ({ ...prev, timezone: e.target.value }))}
                    style={{ width: '100%', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }}
                  >
                    <option value="Europe/Lisbon">🇵🇹 Lisboa (UTC+0/+1)</option>
                    <option value="America/Sao_Paulo">🇧🇷 São Paulo (UTC-3)</option>
                    <option value="America/New_York">🇺🇸 Nova York (UTC-5/-4)</option>
                    <option value="Europe/London">🇬🇧 Londres (UTC+0/+1)</option>
                    <option value="Europe/Paris">🇫🇷 Paris (UTC+1/+2)</option>
                  </select>
                </div>
                
                <div>
                  <label style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}>
                    <input
                      type="checkbox"
                      checked={userInfo.notifications}
                      onChange={e => setUserInfo(prev => ({ ...prev, notifications: e.target.checked }))}
                    />
                    <span>🔔 Ativar notificações e lembretes</span>
                  </label>
                  <small style={{ color: '#666', marginLeft: '1.5rem' }}>
                    Receba lembretes sobre tarefas próximas do prazo
                  </small>
                </div>
                
                <div>
                  <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Prioridade padrão para novas tarefas</label>
                  <select
                    value={userInfo.defaultPriority}
                    onChange={e => setUserInfo(prev => ({ ...prev, defaultPriority: e.target.value }))}
                    style={{ width: '100%', padding: '0.5rem', border: '1px solid #ddd', borderRadius: '4px' }}
                  >
                    <option value="baixa">🟢 Baixa</option>
                    <option value="média">🟡 Média</option>
                    <option value="alta">🟠 Alta</option>
                    <option value="urgente">🔴 Urgente</option>
                  </select>
                </div>
              </div>
              
              <button 
                onClick={handleUserInfoUpdate}
                style={{ 
                  padding: '0.75rem 1.5rem', 
                  backgroundColor: '#28a745', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '4px', 
                  cursor: 'pointer',
                  marginTop: '1.5rem'
                }}
              >
                💾 Guardar preferências
              </button>
            </div>          )}

          {/* Estatísticas */}
          {activeSection === 'stats' && (
            <div>
              <h3>📊 Estatísticas de Uso</h3>
              
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem' }}>
                <div style={{ backgroundColor: '#e3f2fd', padding: '1rem', borderRadius: '8px', textAlign: 'center' }}>
                  <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#1976d2' }}>{stats.total}</div>
                  <div style={{ color: '#666' }}>Total de Tarefas</div>
                </div>
                
                <div style={{ backgroundColor: '#e8f5e8', padding: '1rem', borderRadius: '8px', textAlign: 'center' }}>
                  <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#388e3c' }}>{stats.completed}</div>
                  <div style={{ color: '#666' }}>Concluídas</div>
                </div>
                
                <div style={{ backgroundColor: '#fff3e0', padding: '1rem', borderRadius: '8px', textAlign: 'center' }}>
                  <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#f57c00' }}>{stats.pending}</div>
                  <div style={{ color: '#666' }}>Pendentes</div>
                </div>
                
                <div style={{ backgroundColor: '#fce4ec', padding: '1rem', borderRadius: '8px', textAlign: 'center' }}>
                  <div style={{ fontSize: '2rem', fontWeight: 'bold', color: '#c2185b' }}>{stats.overdue}</div>
                  <div style={{ color: '#666' }}>Em Atraso</div>
                </div>
              </div>
              
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '2rem' }}>
                <div>
                  <h4>📈 Produtividade</h4>
                  <div style={{ backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px' }}>
                    <div style={{ marginBottom: '0.5rem' }}>
                      <strong>Taxa de conclusão:</strong> {stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0}%
                    </div>
                    <div style={{ marginBottom: '0.5rem' }}>
                      <strong>Média por dia:</strong> {stats.averagePerDay || 0} tarefas
                    </div>
                    <div style={{ marginBottom: '0.5rem' }}>
                      <strong>Sequência atual:</strong> {stats.currentStreak || 0} dias
                    </div>
                  </div>
                </div>
                
                <div>
                  <h4>🏷️ Por Categoria</h4>
                  <div style={{ backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px' }}>
                    {Object.entries(stats.byCategory || {}).map(([category, count]) => (
                      <div key={category} style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                        <span style={{ textTransform: 'capitalize' }}>{category}:</span>
                        <strong>{count}</strong>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              
              <div style={{ marginTop: '2rem' }}>
                <h4>📊 Dados da Conta</h4>
                <div style={{ backgroundColor: '#f8f9fa', padding: '1rem', borderRadius: '8px' }}>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                    <div>
                      <strong>Membro desde:</strong> {new Date(user.createdAt).toLocaleDateString('pt-PT')}
                    </div>
                    <div>
                      <strong>Última atualização:</strong> {user.updatedAt ? new Date(user.updatedAt).toLocaleDateString('pt-PT') : 'Nunca'}
                    </div>
                    <div>
                      <strong>País:</strong> {user.countryName || 'Não definido'}
                    </div>
                    <div>
                      <strong>Fuso horário:</strong> {userInfo.timezone}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Ações críticas */}
          {activeSection === 'actions' && (
            <div>
              <h3>🗑️ Ações críticas</h3>
              
              <div style={{ display: 'grid', gap: '2rem' }}>
                <div>
                  <h4>📊 Exportar dados</h4>
                  <p style={{ color: '#666', fontSize: '0.9rem' }}>
                    Baixe todos os seus dados (tarefas, configurações) em formato JSON ou CSV.
                  </p>
                  <div style={{ display: 'flex', gap: '1rem' }}>
                    <button 
                      onClick={() => handleExportData('json')}
                      style={{ 
                        padding: '0.5rem 1rem', 
                        backgroundColor: '#17a2b8', 
                        color: 'white', 
                        border: 'none', 
                        borderRadius: '4px', 
                        cursor: 'pointer' 
                      }}
                    >
                      📥 Exportar JSON
                    </button>
                    <button 
                      onClick={() => handleExportData('csv')}
                      style={{ 
                        padding: '0.5rem 1rem', 
                        backgroundColor: '#28a745', 
                        color: 'white', 
                        border: 'none', 
                        borderRadius: '4px', 
                        cursor: 'pointer' 
                      }}
                    >
                      📊 Exportar CSV
                    </button>
                  </div>
                </div>
                
                <div style={{ borderTop: '1px solid #ddd', paddingTop: '2rem' }}>
                  <h4 style={{ color: '#dc3545' }}>⚠️ Zona de perigo</h4>
                  <p style={{ color: '#666', fontSize: '0.9rem' }}>
                    Esta ação não pode ser desfeita. Todos os seus dados serão permanentemente eliminados.
                  </p>
                  <button 
                    onClick={handleDeleteAccount}
                    style={{ 
                      padding: '0.75rem 1.5rem', 
                      backgroundColor: '#dc3545', 
                      color: 'white', 
                      border: 'none', 
                      borderRadius: '4px', 
                      cursor: 'pointer',
                      fontWeight: 'bold'
                    }}
                  >
                    🗑️ Eliminar conta permanentemente
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// Componente Sidebar de Tarefas
function TasksSidebar({ tasks, darkMode, onTaskUpdated }) {
  const today = new Date().toISOString().split('T')[0];
  const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
  const nextWeek = new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0];

  const todayTasks = tasks.filter(task => 
    task.dueDate === today && task.status !== 'concluída'
  );
  
  const upcomingTasks = tasks.filter(task => 
    task.dueDate > today && task.dueDate <= nextWeek && task.status !== 'concluída'
  );

  const overdueTasks = tasks.filter(task => 
    task.dueDate < today && task.status !== 'concluída'
  );

  const completedToday = tasks.filter(task => 
    task.status === 'concluída' && 
    new Date(task.updatedAt || task.createdAt).toISOString().split('T')[0] === today
  );

  const toggleTaskStatus = async (task) => {
    const newStatus = task.status === 'concluída' ? 'pendente' : 'concluída';
    const updatedTask = { ...task, status: newStatus, updatedAt: new Date().toISOString() };
    onTaskUpdated(updatedTask);
  };

  const TaskItem = ({ task, isOverdue = false }) => (
    <div style={{
      padding: '0.75rem',
      backgroundColor: darkMode ? '#2a2a2a' : '#f8f9fa',
      border: `1px solid ${isOverdue ? '#dc3545' : (darkMode ? '#444' : '#e0e0e0')}`,
      borderRadius: '6px',
      marginBottom: '0.5rem',
      borderLeft: `4px solid ${isOverdue ? '#dc3545' : 
        (task.priority === 'alta' ? '#dc3545' : 
         task.priority === 'média' ? '#ffc107' : '#28a745')}`
    }}>
      <div style={{ display: 'flex', alignItems: 'flex-start', gap: '0.5rem' }}>
        <input
          type="checkbox"
          checked={task.status === 'concluída'}
          onChange={() => toggleTaskStatus(task)}
          style={{ marginTop: '2px' }}
        />
        <div style={{ flex: 1 }}>
          <div style={{
            fontSize: '0.9rem',
            fontWeight: '500',
            color: darkMode ? '#fff' : '#333',
            textDecoration: task.status === 'concluída' ? 'line-through' : 'none',
            opacity: task.status === 'concluída' ? 0.6 : 1
          }}>
            {task.title}
          </div>
          {task.dueDate && (
            <div style={{
              fontSize: '0.75rem',
              color: isOverdue ? '#dc3545' : (darkMode ? '#ccc' : '#666'),
              marginTop: '2px'
            }}>
              📅 {new Date(task.dueDate).toLocaleDateString('pt-PT')}
            </div>
          )}
          {task.category && (
            <div style={{
              fontSize: '0.7rem',
              color: darkMode ? '#999' : '#777',
              marginTop: '2px'
            }}>
              🏷️ {task.category}
            </div>
          )}
        </div>
      </div>
    </div>
  );

  return (
    <div>
      {/* Estatísticas rápidas */}
      <div style={{ marginBottom: '1.5rem' }}>
        <div style={{
          display: 'grid',
          gridTemplateColumns: '1fr 1fr',
          gap: '0.5rem',
          marginBottom: '1rem'
        }}>
          <div style={{
            padding: '0.75rem',
            backgroundColor: darkMode ? '#2a4d3a' : '#e8f5e8',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: darkMode ? '#4ade80' : '#166534' }}>
              {completedToday.length}
            </div>
            <div style={{ fontSize: '0.7rem', color: darkMode ? '#86efac' : '#15803d' }}>
              Concluídas hoje
            </div>
          </div>
          <div style={{
            padding: '0.75rem',
            backgroundColor: darkMode ? '#3b2a2a' : '#fef2f2',
            borderRadius: '6px',
            textAlign: 'center'
          }}>
            <div style={{ fontSize: '1.2rem', fontWeight: 'bold', color: darkMode ? '#f87171' : '#dc2626' }}>
              {overdueTasks.length}
            </div>
            <div style={{ fontSize: '0.7rem', color: darkMode ? '#fca5a5' : '#ef4444' }}>
              Em atraso
            </div>
          </div>
        </div>
      </div>

      {/* Tarefas em atraso */}
      {overdueTasks.length > 0 && (
        <div style={{ marginBottom: '1.5rem' }}>
          <h4 style={{ 
            fontSize: '0.9rem', 
            fontWeight: 'bold', 
            color: '#dc3545', 
            marginBottom: '0.75rem',
            display: 'flex',
            alignItems: 'center',
            gap: '0.5rem'
          }}>
            ⚠️ Em Atraso ({overdueTasks.length})
          </h4>
          {overdueTasks.slice(0, 3).map(task => (
            <TaskItem key={task._id} task={task} isOverdue={true} />
          ))}
          {overdueTasks.length > 3 && (
            <div style={{ fontSize: '0.8rem', color: darkMode ? '#999' : '#666', textAlign: 'center' }}>
              +{overdueTasks.length - 3} mais...
            </div>
          )}
        </div>
      )}

      {/* Tarefas de hoje */}
      <div style={{ marginBottom: '1.5rem' }}>
        <h4 style={{ 
          fontSize: '0.9rem', 
          fontWeight: 'bold', 
          color: darkMode ? '#fff' : '#333', 
          marginBottom: '0.75rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem'
        }}>
          📅 Hoje ({todayTasks.length})
        </h4>
        {todayTasks.length > 0 ? (
          todayTasks.slice(0, 4).map(task => (
            <TaskItem key={task._id} task={task} />
          ))
        ) : (
          <div style={{ 
            fontSize: '0.8rem', 
            color: darkMode ? '#999' : '#666', 
            fontStyle: 'italic',
            textAlign: 'center',
            padding: '1rem'
          }}>
            Nenhuma tarefa para hoje! 🎉
          </div>
        )}
        {todayTasks.length > 4 && (
          <div style={{ fontSize: '0.8rem', color: darkMode ? '#999' : '#666', textAlign: 'center' }}>
            +{todayTasks.length - 4} mais...
          </div>
        )}
      </div>

      {/* Próximas tarefas */}
      <div>
        <h4 style={{ 
          fontSize: '0.9rem', 
          fontWeight: 'bold', 
          color: darkMode ? '#fff' : '#333', 
          marginBottom: '0.75rem',
          display: 'flex',
          alignItems: 'center',
          gap: '0.5rem'
        }}>
          ⏰ Próximos 7 dias ({upcomingTasks.length})
        </h4>
        {upcomingTasks.length > 0 ? (
          upcomingTasks.slice(0, 5).map(task => (
            <TaskItem key={task._id} task={task} />
          ))
        ) : (
          <div style={{ 
            fontSize: '0.8rem', 
            color: darkMode ? '#999' : '#666', 
            fontStyle: 'italic',
            textAlign: 'center',
            padding: '1rem'
          }}>
            Nenhuma tarefa próxima
          </div>
        )}
        {upcomingTasks.length > 5 && (
          <div style={{ fontSize: '0.8rem', color: darkMode ? '#999' : '#666', textAlign: 'center' }}>
            +{upcomingTasks.length - 5} mais...
          </div>
        )}
      </div>
    </div>
  );
}

// Componente de Agenda
function AgendaView({ darkMode }) {
  const [currentDate, setCurrentDate] = React.useState(new Date());
  const [selectedDate, setSelectedDate] = React.useState(new Date());
  const [events, setEvents] = React.useState([]);
  const [showEventForm, setShowEventForm] = React.useState(false);
  const [editingEvent, setEditingEvent] = React.useState(null);
  const [loading, setLoading] = React.useState(false);
  const [eventForm, setEventForm] = React.useState({
    title: '',
    description: '',
    date: '',
    time: '',
    type: 'event',
    priority: 'medium'
  });

  // Carregar eventos usando o eventsService
  const loadEvents = async () => {
    try {
      setLoading(true);
      const loadedEvents = await window.eventsService.getEvents();
      setEvents(loadedEvents);
      
      // Se não há eventos e estamos em modo offline, criar eventos de exemplo
      if (loadedEvents.length === 0 && !window.authService.isOnlineMode) {
        const sampleEvents = [
          {
            title: "Reunião de equipe",
            description: "Reunião semanal da equipe de desenvolvimento",
            date: new Date().toISOString().split('T')[0],
            time: "09:00",
            type: "meeting",
            priority: "high"
          },
          {
            title: "Apresentação do projeto",
            description: "Apresentação do projeto para o cliente",
            date: new Date(Date.now() + 86400000).toISOString().split('T')[0],
            time: "14:30",
            type: "presentation",
            priority: "high"
          }
        ];
        
        // Criar eventos de exemplo
        for (const eventData of sampleEvents) {
          await window.eventsService.addEvent(eventData);
        }
        
        // Recarregar eventos após criar exemplos
        const updatedEvents = await window.eventsService.getEvents();
        setEvents(updatedEvents);
      }
    } catch (error) {
      console.error('Erro ao carregar eventos:', error);
    } finally {
      setLoading(false);
    }
  };

  React.useEffect(() => {
    loadEvents();
  }, []);

  // Funções do calendário
  const monthNames = [
    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];

  const weekDays = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];

  const getDaysInMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  };

  const getFirstDayOfMonth = (date) => {
    return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
  };

  const isToday = (day) => {
    const today = new Date();
    return day === today.getDate() && 
           currentDate.getMonth() === today.getMonth() && 
           currentDate.getFullYear() === today.getFullYear();
  };

  const isSelected = (day) => {
    return day === selectedDate.getDate() && 
           currentDate.getMonth() === selectedDate.getMonth() && 
           currentDate.getFullYear() === selectedDate.getFullYear();
  };  const hasEvents = async (day) => {
    const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    try {
      return await window.eventsService.hasEventsOnDate(dateStr);
    } catch (error) {
      console.error('Erro ao verificar eventos:', error);
      // Fallback para verificação local
      return events.some(event => event.date === dateStr);
    }
  };

  const navigateMonth = (direction) => {
    const newDate = new Date(currentDate);
    newDate.setMonth(currentDate.getMonth() + direction);
    setCurrentDate(newDate);
  };

  const navigateYear = (direction) => {
    const newDate = new Date(currentDate);
    newDate.setFullYear(currentDate.getFullYear() + direction);
    setCurrentDate(newDate);
  };

  const selectDate = (day) => {
    const newSelectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
    setSelectedDate(newSelectedDate);
  };

  // Funções dos eventos
  const getSelectedDateEvents = () => {
    const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
    return events.filter(event => event.date === dateStr).sort((a, b) => a.time.localeCompare(b.time));
  };

  const handleEventSubmit = async (e) => {
    e.preventDefault();
    
    if (!eventForm.title || !eventForm.date || !eventForm.time) {
      alert('Por favor, preencha todos os campos obrigatórios.');
      return;
    }

    try {
      setLoading(true);

      if (editingEvent) {
        // Editar evento existente
        await window.eventsService.updateEvent(editingEvent.id, eventForm);
      } else {
        // Criar novo evento
        await window.eventsService.addEvent(eventForm);
      }

      // Recarregar eventos após a operação
      await loadEvents();

      // Reset form
      setEventForm({ title: '', description: '', date: '', time: '', type: 'event', priority: 'medium' });
      setEditingEvent(null);
      setShowEventForm(false);
    } catch (error) {
      console.error('Erro ao salvar evento:', error);
      alert('Erro ao salvar evento. Tente novamente.');
    } finally {
      setLoading(false);
    }
  };

  const editEvent = (event) => {
    setEventForm(event);
    setEditingEvent(event);
    setShowEventForm(true);
  };

  const deleteEvent = async (eventId) => {
    if (confirm('Tem certeza que deseja eliminar este evento?')) {
      try {
        setLoading(true);
        await window.eventsService.deleteEvent(eventId);
        await loadEvents(); // Recarregar eventos após deletar
      } catch (error) {
        console.error('Erro ao eliminar evento:', error);
        alert('Erro ao eliminar evento. Tente novamente.');
      } finally {
        setLoading(false);
      }
    }
  };
  const openNewEventForm = () => {
    // Sempre usar o dia atualmente selecionado no calendário
    const dateStr = `${selectedDate.getFullYear()}-${String(selectedDate.getMonth() + 1).padStart(2, '0')}-${String(selectedDate.getDate()).padStart(2, '0')}`;
    
    setEventForm({
      title: '',
      description: '',
      date: dateStr,
      time: '',
      type: 'event',
      priority: 'medium'
    });
    setEditingEvent(null);
    setShowEventForm(true);
  };
  // Componente para cada dia do calendário
  const CalendarDay = ({ day, isEmpty = false }) => {
    const [dayHasEvents, setDayHasEvents] = React.useState(false);

    React.useEffect(() => {
      if (!isEmpty) {
        const checkEvents = async () => {
          const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          // Verificação local primeiro (mais rápida)
          const localHasEvents = events.some(event => event.date === dateStr);
          setDayHasEvents(localHasEvents);
          
          // Verificação via serviço (para modo online)
          try {
            const serviceHasEvents = await window.eventsService.hasEventsOnDate(dateStr);
            if (serviceHasEvents !== localHasEvents) {
              setDayHasEvents(serviceHasEvents);
            }
          } catch (error) {
            console.error('Erro ao verificar eventos via serviço:', error);
          }
        };
        
        checkEvents();
      }
    }, [day, isEmpty, events, currentDate]);    if (isEmpty) {
      return <div style={{ height: '32px' }}></div>;
    }return (
      <div
        onClick={() => selectDate(day)}
        style={{
          height: '32px',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          cursor: 'pointer',
          backgroundColor: isSelected(day) ? '#007bff' : (isToday(day) ? '#28a745' : 'transparent'),
          color: isSelected(day) || isToday(day) ? 'white' : (darkMode ? '#fff' : '#333'),
          borderRadius: '4px',
          position: 'relative',
          border: `1px solid ${darkMode ? '#555' : '#e0e0e0'}`,
          transition: 'all 0.2s ease'
        }}
        onMouseEnter={(e) => {
          if (!isSelected(day) && !isToday(day)) {
            e.currentTarget.style.backgroundColor = darkMode ? '#444' : '#f0f0f0';
          }
        }}
        onMouseLeave={(e) => {
          if (!isSelected(day) && !isToday(day)) {
            e.currentTarget.style.backgroundColor = 'transparent';
          }
        }}
      >
        <span style={{ fontSize: '0.8rem', fontWeight: isToday(day) ? 'bold' : 'normal' }}>
          {day}
        </span>
        {dayHasEvents && (
          <div style={{
            width: '4px',
            height: '4px',
            backgroundColor: isSelected(day) || isToday(day) ? 'white' : '#007bff',
            borderRadius: '50%',
            position: 'absolute',
            bottom: '2px'
          }}></div>
        )}
      </div>
    );
  };

  // Renderizar calendário
  const renderCalendar = () => {
    const daysInMonth = getDaysInMonth(currentDate);
    const firstDay = getFirstDayOfMonth(currentDate);
    const days = [];

    // Dias em branco do mês anterior
    for (let i = 0; i < firstDay; i++) {
      days.push(<CalendarDay key={`empty-${i}`} day={0} isEmpty={true} />);
    }

    // Dias do mês atual
    for (let day = 1; day <= daysInMonth; day++) {
      days.push(<CalendarDay key={day} day={day} />);
    }

    return days;
  };

  const getEventTypeIcon = (type) => {
    const icons = {
      'event': '📅',
      'meeting': '🤝',
      'task': '✅',
      'reminder': '🔔',
      'presentation': '📊',
      'appointment': '👨‍⚕️',
      'birthday': '🎂',
      'holiday': '🏖️'
    };
    return icons[type] || '📅';
  };

  const getPriorityColor = (priority) => {
    const colors = {
      'low': '#28a745',
      'medium': '#ffc107',
      'high': '#dc3545'
    };
    return colors[priority] || '#6c757d';
  };  return (
    <div style={{ 
      padding: '0.75rem', 
      display: window.innerWidth > 768 ? 'grid' : 'block',
      gridTemplateColumns: window.innerWidth > 1024 ? '1fr 350px' : '1fr',
      gap: '1rem',
      height: 'calc(100vh - 160px)',
      maxWidth: '100%',
      overflow: 'hidden'
    }}>{/* Calendário */}
      <div style={{
        backgroundColor: darkMode ? '#2a2a2a' : '#ffffff',
        borderRadius: '8px',
        padding: '1rem',
        border: `1px solid ${darkMode ? '#444' : '#e0e0e0'}`,
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        overflow: 'hidden'
      }}>        {/* Header do Calendário */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center', 
          marginBottom: '1rem' 
        }}>          <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
            <button
              onClick={() => navigateYear(-1)}
              style={{
                padding: '0.4rem',
                backgroundColor: 'transparent',
                border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                borderRadius: '4px',
                cursor: 'pointer',
                color: darkMode ? '#fff' : '#333',
                fontSize: '0.8rem'
              }}
            >
              ⏪
            </button>
            <button
              onClick={() => navigateMonth(-1)}
              style={{
                padding: '0.4rem',
                backgroundColor: 'transparent',
                border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                borderRadius: '4px',
                cursor: 'pointer',
                color: darkMode ? '#fff' : '#333',
                fontSize: '0.8rem'
              }}
            >
              ◀
            </button>
            
            <h3 style={{ 
              margin: 0, 
              color: darkMode ? '#fff' : '#333',
              minWidth: '180px',
              textAlign: 'center',
              fontSize: '1.1rem'
            }}>
              {monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}
            </h3>
            
            <button
              onClick={() => navigateMonth(1)}
              style={{
                padding: '0.4rem',
                backgroundColor: 'transparent',
                border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                borderRadius: '4px',
                cursor: 'pointer',
                color: darkMode ? '#fff' : '#333',
                fontSize: '0.8rem'
              }}
            >
              ▶
            </button>
            <button
              onClick={() => navigateYear(1)}
              style={{
                padding: '0.4rem',
                backgroundColor: 'transparent',
                border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                borderRadius: '4px',
                cursor: 'pointer',
                color: darkMode ? '#fff' : '#333',
                fontSize: '0.8rem'
              }}
            >
              ⏩
            </button>
          </div>          
          <button
            onClick={() => {
              setCurrentDate(new Date());
              setSelectedDate(new Date());
            }}
            style={{
              padding: '0.4rem 0.8rem',
              backgroundColor: '#007bff',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: 'pointer',
              fontSize: '0.8rem'
            }}
          >
            Hoje
          </button>
        </div>        {/* Dias da Semana */}
        <div style={{ 
          display: 'grid', 
          gridTemplateColumns: 'repeat(7, 1fr)', 
          gap: '2px', 
          marginBottom: '0.4rem' 
        }}>
          {weekDays.map(day => (
            <div 
              key={day} 
              style={{ 
                textAlign: 'center', 
                fontWeight: 'bold', 
                color: darkMode ? '#ccc' : '#666',
                padding: '0.3rem',
                fontSize: '0.7rem'
              }}
            >
              {day}
            </div>
          ))}
        </div>

        {/* Dias do Mês */}
        <div style={{ 
          display: 'grid', 
          gridTemplateColumns: 'repeat(7, 1fr)', 
          gap: '2px' 
        }}>
          {renderCalendar()}
        </div>

        {/* Legenda */}
        <div style={{ 
          marginTop: '0.75rem', 
          display: 'flex', 
          justifyContent: 'center', 
          gap: '1rem',
          fontSize: '0.7rem',
          color: darkMode ? '#ccc' : '#666'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem' }}>
            <div style={{ width: '8px', height: '8px', backgroundColor: '#28a745', borderRadius: '50%' }}></div>
            <span>Hoje</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem' }}>
            <div style={{ width: '8px', height: '8px', backgroundColor: '#007bff', borderRadius: '50%' }}></div>
            <span>Selecionado</span>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '0.3rem' }}>
            <div style={{ width: '4px', height: '4px', backgroundColor: '#007bff', borderRadius: '50%' }}></div>
            <span>Com eventos</span>
          </div>
        </div>
      </div>      {/* Dashboard de Eventos */}
      <div style={{
        backgroundColor: darkMode ? '#2a2a2a' : '#ffffff',
        borderRadius: '8px',
        padding: '1rem',
        border: `1px solid ${darkMode ? '#444' : '#e0e0e0'}`,
        boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        display: 'flex',
        flexDirection: 'column',
        overflow: 'hidden',
        marginTop: window.innerWidth <= 1024 ? '1rem' : '0',
        height: window.innerWidth <= 1024 ? 'auto' : 'calc(100vh - 200px)'
      }}>{/* Header do Dashboard */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center', 
          marginBottom: '1rem',
          borderBottom: `1px solid ${darkMode ? '#444' : '#e0e0e0'}`,
          paddingBottom: '0.75rem'
        }}>
          <h3 style={{ margin: 0, color: darkMode ? '#fff' : '#333', fontSize: '1rem' }}>
            📅 Eventos - {selectedDate.toLocaleDateString('pt-PT')}
            {loading && (
              <span style={{ 
                marginLeft: '0.5rem', 
                fontSize: '0.7rem', 
                color: darkMode ? '#ccc' : '#666' 
              }}>
                🔄 Carregando...
              </span>
            )}
          </h3>
          <button
            onClick={openNewEventForm}
            disabled={loading}
            style={{
              padding: '0.4rem 0.8rem',
              backgroundColor: loading ? '#6c757d' : '#28a745',
              color: 'white',
              border: 'none',
              borderRadius: '4px',
              cursor: loading ? 'not-allowed' : 'pointer',
              fontSize: '0.8rem',
              opacity: loading ? 0.6 : 1
            }}
          >
            + Novo Evento
          </button>
        </div>

        {/* Lista de Eventos */}
        <div style={{ flex: 1, overflowY: 'auto' }}>          {loading ? (
            <div style={{ 
              textAlign: 'center', 
              color: darkMode ? '#999' : '#666',
              padding: '2rem'
            }}>
              <div className="loading-spinner" style={{ 
                fontSize: '2rem', 
                marginBottom: '1rem'
              }}>
                🔄
              </div>
              <div>Carregando eventos...</div>
            </div>
          ) : getSelectedDateEvents().length > 0 ? (
            getSelectedDateEvents().map(event => (
              <div
                key={event.id}
                style={{
                  padding: '1rem',
                  backgroundColor: darkMode ? '#3a3a3a' : '#f8f9fa',
                  border: `1px solid ${darkMode ? '#555' : '#e0e0e0'}`,
                  borderLeft: `4px solid ${getPriorityColor(event.priority)}`,
                  borderRadius: '8px',
                  marginBottom: '1rem'
                }}
              >
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'flex-start',
                  marginBottom: '0.5rem'
                }}>
                  <div style={{ flex: 1 }}>
                    <div style={{ 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '0.5rem',
                      marginBottom: '0.25rem'
                    }}>
                      <span>{getEventTypeIcon(event.type)}</span>
                      <h4 style={{ 
                        margin: 0, 
                        color: darkMode ? '#fff' : '#333',
                        fontSize: '1rem'
                      }}>
                        {event.title}
                      </h4>
                    </div>
                    <div style={{ 
                      color: darkMode ? '#ccc' : '#666',
                      fontSize: '0.9rem',
                      fontWeight: 'bold',
                      marginBottom: '0.5rem'
                    }}>
                      🕐 {event.time}
                    </div>
                    {event.description && (
                      <p style={{ 
                        margin: 0, 
                        color: darkMode ? '#ccc' : '#666',
                        fontSize: '0.85rem',
                        lineHeight: '1.4'
                      }}>
                        {event.description}
                      </p>
                    )}
                  </div>
                  
                  <div style={{ display: 'flex', gap: '0.5rem', marginLeft: '1rem' }}>
                    <button
                      onClick={() => editEvent(event)}
                      style={{
                        padding: '0.25rem 0.5rem',
                        backgroundColor: '#007bff',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '0.8rem'
                      }}
                    >
                      ✏️
                    </button>
                    <button
                      onClick={() => deleteEvent(event.id)}
                      style={{
                        padding: '0.25rem 0.5rem',
                        backgroundColor: '#dc3545',
                        color: 'white',
                        border: 'none',
                        borderRadius: '4px',
                        cursor: 'pointer',
                        fontSize: '0.8rem'
                      }}
                    >
                      🗑️
                    </button>
                  </div>
                </div>
              </div>
            ))
          ) : (
            <div style={{ 
              textAlign: 'center', 
              color: darkMode ? '#999' : '#666',
              fontStyle: 'italic',
              padding: '2rem'
            }}>
              Nenhum evento agendado para este dia.
              <br />
              <button
                onClick={openNewEventForm}
                style={{
                  marginTop: '1rem',
                  padding: '0.5rem 1rem',
                  backgroundColor: '#007bff',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
              >
                Criar primeiro evento
              </button>
            </div>
          )}
        </div>
      </div>

      {/* Modal de Formulário de Evento */}
      {showEventForm && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0,0,0,0.5)',
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          zIndex: 1000
        }}>
          <div style={{
            backgroundColor: darkMode ? '#2a2a2a' : '#ffffff',
            borderRadius: '12px',
            padding: '2rem',
            width: '500px',
            maxHeight: '80vh',
            overflowY: 'auto',
            border: `1px solid ${darkMode ? '#444' : '#e0e0e0'}`
          }}>
            <h3 style={{ 
              margin: '0 0 1.5rem 0', 
              color: darkMode ? '#fff' : '#333'
            }}>
              {editingEvent ? 'Editar Evento' : 'Novo Evento'}
            </h3>
            
            <form onSubmit={handleEventSubmit}>
              <div style={{ marginBottom: '1rem' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: '0.5rem',
                  color: darkMode ? '#ccc' : '#555',
                  fontWeight: 'bold'
                }}>
                  Título *
                </label>
                <input
                  type="text"
                  value={eventForm.title}
                  onChange={(e) => setEventForm({...eventForm, title: e.target.value})}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                    borderRadius: '4px',
                    backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                    color: darkMode ? '#fff' : '#333'
                  }}
                  required
                />
              </div>

              <div style={{ marginBottom: '1rem' }}>
                <label style={{ 
                  display: 'block', 
                  marginBottom: '0.5rem',
                  color: darkMode ? '#ccc' : '#555',
                  fontWeight: 'bold'
                }}>
                  Descrição
                </label>
                <textarea
                  value={eventForm.description}
                  onChange={(e) => setEventForm({...eventForm, description: e.target.value})}
                  rows={3}
                  style={{
                    width: '100%',
                    padding: '0.75rem',
                    border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                    borderRadius: '4px',
                    backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                    color: darkMode ? '#fff' : '#333',
                    resize: 'vertical'
                  }}
                />
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1rem' }}>                <div>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '0.5rem',
                    color: darkMode ? '#ccc' : '#555',
                    fontWeight: 'bold'
                  }}>
                    Data *
                  </label>
                  {!editingEvent && (
                    <div style={{
                      fontSize: '0.8rem',
                      color: darkMode ? '#999' : '#666',
                      marginBottom: '0.25rem',
                      fontStyle: 'italic'
                    }}>
                      📅 Dia selecionado: {selectedDate.toLocaleDateString('pt-PT')}
                    </div>
                  )}
                  <input
                    type="date"
                    value={eventForm.date}
                    onChange={(e) => setEventForm({...eventForm, date: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                      borderRadius: '4px',
                      backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                      color: darkMode ? '#fff' : '#333'
                    }}
                    required
                  />
                </div>

                <div>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '0.5rem',
                    color: darkMode ? '#ccc' : '#555',
                    fontWeight: 'bold'
                  }}>
                    Hora *
                  </label>
                  <input
                    type="time"
                    value={eventForm.time}
                    onChange={(e) => setEventForm({...eventForm, time: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                      borderRadius: '4px',
                      backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                      color: darkMode ? '#fff' : '#333'
                    }}
                    required
                  />
                </div>
              </div>

              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                <div>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '0.5rem',
                    color: darkMode ? '#ccc' : '#555',
                    fontWeight: 'bold'
                  }}>
                    Tipo
                  </label>
                  <select
                    value={eventForm.type}
                    onChange={(e) => setEventForm({...eventForm, type: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                      borderRadius: '4px',
                      backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                      color: darkMode ? '#fff' : '#333'
                    }}
                  >
                    <option value="event">📅 Evento</option>
                    <option value="meeting">🤝 Reunião</option>
                    <option value="task">✅ Tarefa</option>
                    <option value="reminder">🔔 Lembrete</option>
                    <option value="presentation">📊 Apresentação</option>
                    <option value="appointment">👨‍⚕️ Consulta</option>
                    <option value="birthday">🎂 Aniversário</option>
                    <option value="holiday">🏖️ Feriado</option>
                  </select>
                </div>

                <div>
                  <label style={{ 
                    display: 'block', 
                    marginBottom: '0.5rem',
                    color: darkMode ? '#ccc' : '#555',
                    fontWeight: 'bold'
                  }}>
                    Prioridade
                  </label>
                  <select
                    value={eventForm.priority}
                    onChange={(e) => setEventForm({...eventForm, priority: e.target.value})}
                    style={{
                      width: '100%',
                      padding: '0.75rem',
                      border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
                      borderRadius: '4px',
                      backgroundColor: darkMode ? '#3a3a3a' : '#ffffff',
                      color: darkMode ? '#fff' : '#333'
                    }}
                  >
                    <option value="low">🟢 Baixa</option>
                    <option value="medium">🟡 Média</option>
                    <option value="high">🔴 Alta</option>
                  </select>
                </div>
              </div>              <div style={{ display: 'flex', gap: '1rem', justifyContent: 'flex-end' }}>
                <button
                  type="button"
                  onClick={() => {
                    setShowEventForm(false);
                    setEditingEvent(null);
                    setEventForm({ title: '', description: '', date: '', time: '', type: 'event', priority: 'medium' });
                  }}
                  disabled={loading}
                  style={{
                    padding: '0.75rem 1.5rem',
                    backgroundColor: '#6c757d',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    opacity: loading ? 0.6 : 1
                  }}
                >
                  Cancelar
                </button>
                <button
                  type="submit"
                  disabled={loading}
                  style={{
                    padding: '0.75rem 1.5rem',
                    backgroundColor: loading ? '#6c757d' : '#28a745',
                    color: 'white',
                    border: 'none',
                    borderRadius: '4px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    opacity: loading ? 0.6 : 1,
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  {loading && <span className="loading-spinner">🔄</span>}
                  {editingEvent ? 'Atualizar' : 'Criar'} Evento
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

// Componente de Configurações
function SettingsView({ darkMode, toggleDarkMode, user }) {
  const [notifications, setNotifications] = React.useState(true);
  const [emailUpdates, setEmailUpdates] = React.useState(false);
  const [newsCategories, setNewsCategories] = React.useState(['technology', 'business']);

  const categories = [
    { id: 'general', name: 'Geral', icon: '🌍' },
    { id: 'technology', name: 'Tecnologia', icon: '💻' },
    { id: 'business', name: 'Negócios', icon: '💼' },
    { id: 'health', name: 'Saúde', icon: '🏥' },
    { id: 'science', name: 'Ciência', icon: '🔬' },
    { id: 'sports', name: 'Desportos', icon: '⚽' },
    { id: 'entertainment', name: 'Entretenimento', icon: '🎬' }
  ];

  const toggleCategory = (categoryId) => {
    setNewsCategories(prev => 
      prev.includes(categoryId) 
        ? prev.filter(id => id !== categoryId)
        : [...prev, categoryId]
    );
  };
  return (
    <div style={{ padding: '1rem', maxWidth: '600px' }}>
      <h3 style={{ marginBottom: '1.5rem', color: darkMode ? '#fff' : '#333' }}>⚙️ Configurações</h3>
      
      {/* Notificações */}
      <div style={{ marginBottom: '2rem' }}>
        <h4 style={{ color: darkMode ? '#ccc' : '#555', marginBottom: '1rem' }}>Notificações</h4>
        <div style={{ 
          padding: '1rem', 
          backgroundColor: darkMode ? '#3a3a3a' : '#f8f9fa',
          border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
          borderRadius: '8px'
        }}>
          <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer', marginBottom: '0.5rem' }}>
            <input 
              type="checkbox" 
              checked={notifications} 
              onChange={(e) => setNotifications(e.target.checked)}
              style={{ marginRight: '0.5rem' }}
            />
            <span style={{ color: darkMode ? '#fff' : '#333' }}>Notificações push</span>
          </label>
          <label style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
            <input 
              type="checkbox" 
              checked={emailUpdates} 
              onChange={(e) => setEmailUpdates(e.target.checked)}
              style={{ marginRight: '0.5rem' }}
            />
            <span style={{ color: darkMode ? '#fff' : '#333' }}>Atualizações por email</span>
          </label>
        </div>
      </div>

      {/* Categorias de Notícias */}
      <div style={{ marginBottom: '2rem' }}>
        <h4 style={{ color: darkMode ? '#ccc' : '#555', marginBottom: '1rem' }}>Categorias de Notícias Favoritas</h4>
        <div style={{ 
          padding: '1rem', 
          backgroundColor: darkMode ? '#3a3a3a' : '#f8f9fa',
          border: `1px solid ${darkMode ? '#555' : '#ddd'}`,
          borderRadius: '8px'
        }}>
          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '0.5rem' }}>
            {categories.map(category => (
              <label key={category.id} style={{ display: 'flex', alignItems: 'center', cursor: 'pointer' }}>
                <input 
                  type="checkbox" 
                  checked={newsCategories.includes(category.id)} 
                  onChange={() => toggleCategory(category.id)}
                  style={{ marginRight: '0.5rem' }}
                />
                <span style={{ color: darkMode ? '#fff' : '#333' }}>
                  {category.icon} {category.name}
                </span>
              </label>
            ))}          </div>
        </div>
      </div>
    </div>
  );
}

function Dashboard() {
  const [tasks, setTasks] = React.useState([]);
  const [user, setUser] = React.useState(null);
  const [currentView, setCurrentView] = React.useState('news'); // 'news', 'tasks', 'agenda', 'settings', 'create', 'profile'
  const [previousView, setPreviousView] = React.useState('news'); // Guardar página anterior
  const [stats, setStats] = React.useState({});  const [darkMode, setDarkMode] = React.useState(false);  const [showProfileMenu, setShowProfileMenu] = React.useState(false);const menuItems = [
    { id: 'news', name: 'Início', icon: '🏠' },
    { id: 'tasks', name: 'Tarefas', icon: '✅' },
    { id: 'agenda', name: 'Agenda', icon: '📅' },
    { id: 'noticias', name: 'Notícias', icon: '📰' }
  ];React.useEffect(() => {
    loadTasks();
    loadUserData();
    
    // Load dark mode preference
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    setDarkMode(savedDarkMode);
    document.body.style.backgroundColor = savedDarkMode ? '#121212' : '#ffffff';
    document.body.style.color = savedDarkMode ? '#ffffff' : '#000000';
    
    // Definir função global para atualizar dados do usuário
    window.updateUserData = (updatedUser) => {
      setUser(updatedUser);
    };
    
    // Cleanup
    return () => {
      delete window.updateUserData;
    };
  }, []);

  const loadUserData = () => {
    const userData = authService.getUser();
    setUser(userData);
  };

  const toggleDarkMode = () => {
    const newDarkMode = !darkMode;
    setDarkMode(newDarkMode);
    localStorage.setItem('darkMode', newDarkMode.toString());
    
    // Apply dark mode styles to body
    document.body.style.backgroundColor = newDarkMode ? '#121212' : '#ffffff';
    document.body.style.color = newDarkMode ? '#ffffff' : '#000000';  };

  // Função personalizada para navegação que guarda a página anterior
  const navigateToView = (newView) => {
    if (newView === 'create') {
      setPreviousView(currentView); // Guardar página atual antes de ir para create
    }
    setCurrentView(newView);
  };

  const loadTasks = async () => {
    try {
      const tasksData = await tasksService.getTasks();
      setTasks(tasksData);
      setStats(tasksService.getStats());
    } catch (error) {
      console.error('Erro ao carregar tarefas:', error);
    }
  };
  const handleTaskCreated = (newTask) => {
    setTasks(prev => [newTask, ...prev]);
    setStats(tasksService.getStats());
    setCurrentView(previousView); // Volta para a página anterior
  };

  const handleTaskUpdated = (updatedTask) => {
    setTasks(prev => prev.map(task => 
      task._id === updatedTask._id ? updatedTask : task
    ));
    setStats(tasksService.getStats());
  };
  
  const handleTaskDeleted = (taskId) => {
    setTasks(prev => prev.filter(task => task._id !== taskId));
    setStats(tasksService.getStats());
  };
  
  const handleLogout = () => {
    authService.logout();
    window.location.reload();
  };  const toggleProfileMenu = () => {
    setShowProfileMenu(!showProfileMenu);
  };
  // Close profile menu when clicking outside
  React.useEffect(() => {
    const handleClickOutside = (event) => {
      if (showProfileMenu && !event.target.closest('.profile-menu-container')) {
        setShowProfileMenu(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, [showProfileMenu]);
  if (currentView === 'create') {
    return (
      <CreateTaskPage 
        onTaskCreated={handleTaskCreated}
        onBack={() => setCurrentView('news')}
      />
    );
  }

  if (currentView === 'profile') {
    return (
      <ProfilePage 
        onBack={() => setCurrentView('news')}
        user={user}
        stats={stats}
      />
    );
  }  return (
    <div style={{ 
      backgroundColor: darkMode ? '#121212' : '#f5f5f5',
      color: darkMode ? '#ffffff' : '#000000',
      minHeight: '100vh'
    }}>
      {/* Header fixo */}      <header style={{ 
        position: 'fixed',
        top: 0,
        left: 0,
        right: 0,
        zIndex: 1000,
        display: 'flex', 
        justifyContent: 'space-between', 
        alignItems: 'center', 
        backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
        color: darkMode ? '#ffffff' : '#000000',
        padding: '0.75rem 2rem',
        borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',
        height: '70px'
      }}>        <div style={{ display: 'flex', alignItems: 'center' }}>
          <button
            onClick={() => setCurrentView('news')}
            style={{
              width: 40,
              height: 40,
              borderRadius: '50%',
              border: 'none',
              backgroundColor: darkMode ? '#333' : '#f0f0f0',
              color: darkMode ? '#fff' : '#333',
              fontSize: '1.2rem',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
            title="Ir para Início"
            onMouseEnter={(e) => {
              e.target.style.backgroundColor = darkMode ? '#3a3a3a' : '#e8e8e8';
            }}
            onMouseLeave={(e) => {
              e.target.style.backgroundColor = darkMode ? '#333' : '#f0f0f0';
            }}
          >
            🏠
          </button>
        </div>
        
        {/* Botões principais centralizados */}
        <div style={{ display: 'flex', gap: '0.5rem' }}>
          {menuItems.map(item => (
            <button
              key={item.id}
              onClick={() => setCurrentView(item.id)}
              style={{
                padding: '0.5rem 1rem',
                border: 'none',
                backgroundColor: currentView === item.id ? '#007bff' : 'transparent',
                color: currentView === item.id ? '#ffffff' : (darkMode ? '#ccc' : '#666'),
                cursor: 'pointer',
                borderRadius: '6px',
                fontSize: '0.9rem',
                fontWeight: currentView === item.id ? '600' : '400',
                transition: 'all 0.2s',
                display: 'flex',
                alignItems: 'center',
                gap: '0.3rem'
              }}
              onMouseEnter={(e) => {
                if (currentView !== item.id) {
                  e.target.style.backgroundColor = darkMode ? '#3a3a3a' : '#f0f0f0';
                }
              }}
              onMouseLeave={(e) => {
                if (currentView !== item.id) {
                  e.target.style.backgroundColor = 'transparent';
                }
              }}
            >
              <span>{item.icon}</span>
              {item.name}
            </button>
          ))}
        </div>          {/* Informações do utilizador */}
        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
          {user && (
            <div className="profile-menu-container" style={{ position: 'relative' }}>
              <div 
                onClick={toggleProfileMenu}
                style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '0.5rem', 
                  fontSize: '0.95rem',
                  cursor: 'pointer',
                  padding: '0.5rem',
                  borderRadius: '8px',
                  transition: 'background-color 0.2s',
                  backgroundColor: showProfileMenu ? (darkMode ? '#333' : '#f0f0f0') : 'transparent'
                }}
                onMouseEnter={(e) => {
                  if (!showProfileMenu) {
                    e.target.style.backgroundColor = darkMode ? '#2a2a2a' : '#f8f8f8';
                  }
                }}
                onMouseLeave={(e) => {
                  if (!showProfileMenu) {
                    e.target.style.backgroundColor = 'transparent';
                  }
                }}
              >
                <span style={{ color: '#7c3aed', fontSize: '1.2rem' }}>👤</span>
                <span style={{ fontWeight: 500 }}>{user.username}</span>
                {user.country && (
                  <span style={{ fontSize: '1rem' }}>
                    {countries.find(c => c.code === user.country)?.flag}
                  </span>
                )}
                <span style={{ fontSize: '0.8rem', color: darkMode ? '#ccc' : '#666' }}>
                  {showProfileMenu ? '▲' : '▼'}
                </span>
              </div>
              
              {/* Profile Dropdown Menu */}
              {showProfileMenu && (
                <div style={{
                  position: 'absolute',
                  top: '100%',
                  right: 0,
                  marginTop: '0.5rem',
                  backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
                  border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
                  borderRadius: '8px',
                  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                  minWidth: '200px',
                  zIndex: 1001,
                  overflow: 'hidden'
                }}>
                  <div style={{ padding: '0.75rem', borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}` }}>
                    <div style={{ fontWeight: 600, fontSize: '0.9rem' }}>{user.username}</div>
                    <div style={{ fontSize: '0.8rem', color: darkMode ? '#ccc' : '#666', marginTop: '0.25rem' }}>
                      {user.email}
                    </div>
                  </div>
                  
                  <div style={{ padding: '0.5rem 0' }}>                    <button
                      onClick={() => {
                        setCurrentView('profile');
                        setShowProfileMenu(false);
                      }}
                      style={{
                        width: '100%',
                        padding: '0.75rem 1rem',
                        border: 'none',
                        backgroundColor: 'transparent',
                        color: darkMode ? '#fff' : '#000',
                        textAlign: 'left',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        fontSize: '0.9rem',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.target.style.backgroundColor = darkMode ? '#333' : '#f5f5f5';
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                      }}
                    >
                      <span>👤</span>
                      <span>Ver Perfil</span>
                    </button>
                    
                    <div style={{ 
                      height: '1px', 
                      backgroundColor: darkMode ? '#333' : '#e0e0e0', 
                      margin: '0.5rem 0' 
                    }}></div>
                    
                    <button
                      onClick={() => {
                        handleLogout();
                        setShowProfileMenu(false);
                      }}
                      style={{
                        width: '100%',
                        padding: '0.75rem 1rem',
                        border: 'none',
                        backgroundColor: 'transparent',
                        color: '#dc3545',
                        textAlign: 'left',
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '0.75rem',
                        fontSize: '0.9rem',
                        transition: 'background-color 0.2s'
                      }}
                      onMouseEnter={(e) => {
                        e.target.style.backgroundColor = darkMode ? '#2a1f1f' : '#fef2f2';
                      }}
                      onMouseLeave={(e) => {
                        e.target.style.backgroundColor = 'transparent';
                      }}
                    >
                      <span>🚪</span>
                      <span>Sair</span>
                    </button>
                  </div>
                </div>              )}
            </div>
          )}
            {/* Botão de Configurações */}
          <button 
            onClick={() => setCurrentView('settings')}
            style={{ 
              width: 40, height: 40, borderRadius: '50%', border: 'none',
              background: currentView === 'settings' ? (darkMode ? '#444' : '#e0e0e0') : (darkMode ? '#333' : '#f0f0f0'), 
              color: darkMode ? '#fff' : '#333', 
              fontSize: '1.2rem',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              cursor: 'pointer',
              transition: 'all 0.2s',
              marginRight: '0.5rem'
            }}
            title="Configurações"
            onMouseEnter={(e) => {
              if (currentView !== 'settings') {
                e.target.style.backgroundColor = darkMode ? '#3a3a3a' : '#e8e8e8';
              }
            }}
            onMouseLeave={(e) => {
              if (currentView !== 'settings') {
                e.target.style.backgroundColor = darkMode ? '#333' : '#f0f0f0';
              }
            }}
          >
            ⚙️
          </button>
          
            <button
            onClick={toggleDarkMode}
            style={{ 
              width: 40, height: 40, borderRadius: '50%', border: 'none',
              background: darkMode ? '#333' : '#f0f0f0', 
              color: darkMode ? '#fff' : '#333', 
              fontSize: '1.2rem',
              display: 'flex', alignItems: 'center', justifyContent: 'center',
              cursor: 'pointer',
              transition: 'all 0.2s'
            }}
            title={darkMode ? 'Modo claro' : 'Modo escuro'}
          >
            {darkMode ? '☀️' : '🌙'}
          </button>
        </div>      </header>

      {/* Conteúdo principal */}
      <main style={{ 
        marginTop: '70px', // Espaço apenas para o header
        padding: '1rem 2rem',
        maxWidth: '1400px',
        margin: '70px auto 0 auto'
      }}>{currentView === 'news' && (
          <div style={{ display: 'grid', gridTemplateColumns: '3fr 1fr', gap: '1rem', height: 'calc(100vh - 90px)' }}>
            {/* Feed de notícias - coluna esquerda (75%) */}
            <div style={{ 
              backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
              borderRadius: '12px',
              border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
              overflow: 'hidden',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
              height: 'calc(100vh - 100px)',
              marginLeft: '-2rem'
            }}>
              <div style={{ padding: '1.5rem', borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}` }}>
                <h2 style={{ margin: 0, fontSize: '1.4rem', fontWeight: 600 }}>📰 Feed de Notícias</h2>
              </div>
              <div style={{ height: 'calc(100% - 80px)', overflow: 'hidden' }}>
                <NewsSection darkMode={darkMode} />
              </div>
            </div>

            {/* Sidebar de tarefas - coluna direita (25%) */}
            <div style={{ 
              backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
              borderRadius: '12px',
              border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
              overflow: 'hidden',
              boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
            }}>              <div style={{ padding: '1rem', borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <h3 style={{ margin: 0, fontSize: '1.1rem', fontWeight: 600 }}>📋 Tarefas</h3>                <button 
                  onClick={() => navigateToView('create')}
                  style={{ 
                    display: 'flex', alignItems: 'center', gap: '0.3rem',
                    padding: '0.4rem 0.8rem', 
                    backgroundColor: '#28a745', 
                    color: '#fff', 
                    border: 'none', 
                    borderRadius: '6px', 
                    fontWeight: 600,
                    fontSize: '0.75rem',
                    cursor: 'pointer',
                    transition: 'all 0.2s'
                  }}
                  title="Criar Nova Tarefa"
                >
                  ➕
                </button>
              </div>
              <div style={{ height: 'calc(100% - 60px)', overflow: 'auto', padding: '1rem' }}>
                <TasksSidebar tasks={tasks} darkMode={darkMode} onTaskUpdated={handleTaskUpdated} />
              </div>
            </div>
          </div>
        )}{currentView === 'tasks' && (
          <div style={{ 
            backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
            borderRadius: '12px',
            border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
            padding: '2rem',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            marginLeft: '-3rem',
            marginRight: '-2rem'
          }}>            <TasksDashboard
              tasks={tasks}
              onTaskUpdated={handleTaskUpdated}
              onTaskDeleted={handleTaskDeleted}
              navigateToView={navigateToView}
            />
          </div>
        )}        {currentView === 'agenda' && (
          <div style={{ 
            backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
            borderRadius: '12px',
            border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
            padding: '2rem',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            marginLeft: '-3rem',
            marginRight: '-2rem'
          }}>
            <AgendaView darkMode={darkMode} />
          </div>        )}

        {currentView === 'noticias' && (
          <div style={{ 
            backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
            borderRadius: '12px',
            border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
            overflow: 'hidden',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            marginLeft: '-3rem',
            marginRight: '-2rem',
            height: 'calc(100vh - 100px)'
          }}>
            <div style={{ padding: '1.5rem', borderBottom: `1px solid ${darkMode ? '#333' : '#e0e0e0'}` }}>
              <h2 style={{ margin: 0, fontSize: '1.4rem', fontWeight: 600 }}>📰 Notícias Mundiais</h2>
              <p style={{ margin: '0.5rem 0 0 0', color: darkMode ? '#ccc' : '#666', fontSize: '0.9rem' }}>
                Acompanhe as últimas notícias de todo o mundo
              </p>
            </div>
            <div style={{ height: 'calc(100% - 100px)', overflow: 'hidden' }}>
              <NewsSection darkMode={darkMode} />
            </div>
          </div>
        )}        {currentView === 'settings' && (
          <div style={{ 
            backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
            borderRadius: '12px',
            border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
            padding: '2rem',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            marginLeft: '-3rem',
            marginRight: '-2rem'
          }}>
            <SettingsView darkMode={darkMode} toggleDarkMode={toggleDarkMode} user={user} />
          </div>
        )}

        {/* View padrão para casos não tratados */}
        {!['news', 'tasks', 'agenda', 'noticias', 'settings'].includes(currentView) && (
          <div style={{ 
            backgroundColor: darkMode ? '#1a1a1a' : '#ffffff',
            borderRadius: '12px',
            border: `1px solid ${darkMode ? '#333' : '#e0e0e0'}`,
            padding: '2rem',
            boxShadow: '0 4px 12px rgba(0,0,0,0.1)',
            marginLeft: '-3rem',
            marginRight: '-2rem',
            textAlign: 'center'
          }}>
            <h3>⚠️ Página não encontrada</h3>
            <p>A página solicitada não existe.</p>
            <button 
              onClick={() => setCurrentView('news')}
              style={{
                padding: '0.75rem 1.5rem',
                backgroundColor: '#007bff',
                color: '#fff',
                border: 'none',
                borderRadius: '6px',
                fontWeight: 600,
                cursor: 'pointer',
                marginTop: '1rem'
              }}
            >
              🏠 Voltar ao Início
            </button>
          </div>
        )}
      </main>
    </div>
  );
}

function App() {
  const [currentPage, setCurrentPage] = React.useState('login');
  const [isAuthenticated, setIsAuthenticated] = React.useState(false);

  React.useEffect(() => {
    setIsAuthenticated(authService.isAuthenticated());
  }, []);

  if (isAuthenticated) {
    return <Dashboard />;
  }

  return (
    <div>
      {currentPage === 'login' ? (
        <LoginPage onSwitchToRegister={() => setCurrentPage('register')} />
      ) : (
        <RegisterPage onSwitchToLogin={() => setCurrentPage('login')} />
      )}
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
        </script>
    </body>
</html>